import{j as e}from"./ui-BGuvgkTr.js";import{r as n,f as O,u as W}from"./router-BxjC687J.js";import{c as A,l,C as g,L as M,B as d,W as R,u as Z,X as J,Y as I,M as F,o as $,m as K,Z as ee,w as te,q as se,_ as re,$ as ae}from"./index-jWnzXYss.js";import{q as ie}from"./quizResultsService-Uyuxw7Yc.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const oe=({quizId:r,isOwner:s,currentUserId:m})=>{A();const[u,N]=n.useState([]),[Q,p]=n.useState(!0),[i,b]=n.useState(null);n.useEffect(()=>{h()},[r,s,m]);const h=async()=>{try{p(!0),b(null);const a=await ie.getQuizHistory({quizId:r,userId:s?void 0:m,limit:20});N(a),p(!1),l.info("Quiz history loaded","QuizHistory",{quizId:r,resultCount:a.length,isOwner:s})}catch(a){l.error("Failed to load quiz history","QuizHistory",{},a),b("Failed to load history"),p(!1)}},t=a=>{if(!a)return"--:--";const f=Math.floor(a/60),y=a%60;return`${f}:${y.toString().padStart(2,"0")}`},j=a=>new Date(a).toLocaleDateString("vi-VN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return Q?e.jsx(g,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-center py-4",children:[e.jsx(M,{}),e.jsx("span",{className:"ml-2 text-sm text-[var(--color-text-secondary)]",children:"Loading history..."})]})}):i?e.jsx(g,{className:"p-4",children:e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-sm text-[var(--color-danger-accent)] mb-2",children:i}),e.jsx(d,{onClick:h,variant:"outline",size:"sm",children:"Retry"})]})}):u.length===0?e.jsx(g,{className:"p-4",children:e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-[var(--color-text-secondary)]",children:s?"No attempts yet":"You haven't taken this quiz yet"})})}):e.jsxs(g,{className:"p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:[s?"Recent Results":"Your Results"," (",u.length,")"]})}),e.jsx("div",{className:"space-y-2",children:u.map(a=>e.jsx("div",{className:"flex items-center justify-between p-3 bg-[var(--color-bg-surface-2)] rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[s&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(R,{className:"w-4 h-4 text-[var(--color-text-secondary)]"}),e.jsx("span",{className:"text-sm font-medium text-[var(--color-text-primary)]",children:a.user_name})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:`font-semibold ${a.score>=80?"text-[var(--color-success-accent)]":a.score>=60?"text-[var(--color-warning-accent)]":"text-[var(--color-danger-accent)]"}`,children:[a.score,"%"]}),e.jsxs("span",{className:"text-xs text-[var(--color-text-secondary)]",children:["(",Math.round(a.score/100*a.total_questions),"/",a.total_questions,")"]})]}),e.jsx("span",{className:"text-xs text-[var(--color-text-muted)]",children:t(a.time_taken)}),e.jsx("span",{className:"text-xs text-[var(--color-text-muted)]",children:j(a.created_at)})]})},a.id))}),u.length>=20&&e.jsx("div",{className:"mt-3 text-center",children:e.jsx(d,{variant:"ghost",size:"sm",onClick:h,children:"Load More"})})]})},le=()=>{var P,L,T,E;const{quizId:r}=O(),{t:s}=A(),m=W(),{quizzes:u,addQuiz:N,setActiveQuiz:Q,setQuizResult:p,currentUser:i,showSuccessNotification:b,showErrorNotification:h}=Z(),[t,j]=n.useState(null),[a,f]=n.useState(!0),[y,v]=n.useState(null),[S,q]=n.useState(!1),[k,x]=n.useState(""),[D,C]=n.useState(!1);n.useEffect(()=>{(async()=>{if(f(!0),v(null),x(""),!r){l.warn("SharedQuizPage: No quizId in params.","SharedQuizPage"),v(s("sharedQuizNotFound")),x("No quiz ID provided in URL"),f(!1);return}if(!I(r)&&r.length<30){l.warn("SharedQuizPage: Invalid quiz ID format and too short to be a corrupted ID.","SharedQuizPage",{quizId:r}),v(s("sharedQuizNotFound")),x(`Invalid quiz ID format: ${r}`),f(!1);return}I(r)||(l.info("SharedQuizPage: Detected potentially corrupted quiz ID, proceeding to sharing service for recovery","SharedQuizPage",{quizId:r}),x(`Potentially corrupted quiz ID detected: ${r}. Attempting recovery...`));try{if(i){const z=u.find(X=>X.id===r);if(z){l.info("SharedQuizPage: Displaying quiz owned by current user.","SharedQuizPage",{quizId:r}),j(z),x("Quiz found in user's collection"),f(!1);return}}const c=await re(r,i);if(c)l.info("SharedQuizPage: Quiz data fetched successfully.","SharedQuizPage",{quizId:r}),j(c),x("Quiz found via sharing mechanism");else{l.warn("SharedQuizPage: Quiz not found via getSharedQuiz.","SharedQuizPage",{quizId:r});const z=`Quiz ${r} not found. This could be because:
â€¢ The quiz was deleted by its creator
â€¢ The quiz share link has expired  
â€¢ There's a data consistency issue in the database
â€¢ The quiz was never properly shared

ðŸ”§ For detailed diagnosis, open browser console (F12) and run:
window.QuizAIDebug.debugQuizSharing("${r}")

ðŸ› ï¸ If the quiz exists but has data issues, try:
window.QuizAIDebug.cleanupOrphanedQuiz("${r}")`;x(z),v(s("sharedQuizNotFound"))}}catch(c){l.error("Error loading shared quiz:","SharedQuizPage",{quizId:r},c),v(s("sharedQuizLoadError")),x(`Error: ${c.message}`)}finally{f(!1)}})()},[r,u,s,i]);const _=async()=>{const o=window.location.href;try{await navigator.clipboard.writeText(o),q(!0),setTimeout(()=>q(!1),2e3)}catch(c){l.error("Failed to copy share link from SharedQuizPage:","SharedQuizPage",void 0,c)}},H=()=>{t&&(Q(t),p(null),m(`/quiz/${t.id}`))},w=()=>!t||!i?!1:u.some(o=>o.title===t.title&&o.questions.length===t.questions.length),U=async()=>{if(!t||!i){h("Please log in to save quizzes");return}if(w()){h("This quiz is already saved to your collection");return}C(!0);try{const o={...t,id:ae(),userId:i.id,createdAt:new Date().toISOString(),lastModified:new Date().toISOString(),isShared:!1,sharedTimestamp:void 0};N(o),b("Quiz saved to your collection!"),l.info("Shared quiz saved to user collection","SharedQuizPage",{originalQuizId:t.id,newQuizId:o.id,userId:i.id})}catch(o){l.error("Failed to save shared quiz","SharedQuizPage",{quizId:t.id},o),h("Failed to save quiz. Please try again.")}finally{C(!1)}};if(a)return e.jsx("div",{className:"min-h-[calc(100vh-200px)] flex items-center justify-center",children:e.jsx(M,{text:s("loading")+"...",size:"xl"})});if(y||!t)return e.jsx("div",{className:"container mx-auto px-4 py-8 sm:py-12",children:e.jsxs(g,{className:"max-w-lg mx-auto mt-10 sm:mt-16 p-8 text-center animate-fadeInUp shadow-2xl",useGlassEffect:!0,children:[e.jsx(J,{className:"w-16 h-16 text-[var(--color-danger-accent)] mx-auto mb-6"}),e.jsx("h2",{className:"text-2xl font-semibold text-[var(--color-text-primary)] mb-3",children:s("sharedQuizError")}),e.jsx("p",{className:"text-[var(--color-text-secondary)] mb-4",children:y||s("sharedQuizNotFound")}),k&&e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)] p-4 rounded-lg mb-6 text-left",children:[e.jsx("div",{className:"flex items-center mb-2",children:e.jsx("span",{className:"text-sm font-semibold text-[var(--color-text-primary)]",children:"Debug Information"})}),e.jsx("p",{className:"text-xs text-[var(--color-text-muted)] font-mono break-all",children:k}),r&&e.jsxs("p",{className:"text-xs text-[var(--color-text-muted)] font-mono mt-2",children:["Quiz ID: ",r,e.jsx("br",{}),"Valid Format: ",I(r)?"Yes":"No"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[e.jsx(d,{variant:"primary",onClick:()=>m("/"),size:"lg",className:"py-3 px-8 rounded-xl",children:s("home")}),e.jsx(d,{variant:"outline",onClick:()=>m("/create"),size:"lg",className:"py-3 px-8 rounded-xl",children:s("createQuiz")})]})]})});const Y=(P=t.config)!=null&&P.difficulty&&t.config.difficulty!=="AI-Determined"?s(`step2Difficulty${t.config.difficulty}`):((L=t.config)==null?void 0:L.difficulty)==="AI-Determined"?s("dashboardQuizCardDifficulty"):s("notSpecified"),V=(T=t.config)!=null&&T.language?t.config.language.toLowerCase()==="english"?s("step2LanguageEnglish"):s("step2LanguageVietnamese"):s("notSpecified"),B=t.createdAt?new Date(t.createdAt).toLocaleDateString():s("notSpecified"),G=t.lastModified?new Date(t.lastModified).toLocaleDateString():s("notSpecified");return e.jsxs("div",{className:"container mx-auto px-4 py-8 sm:py-12",children:[e.jsxs(g,{className:"max-w-3xl mx-auto shadow-2xl !rounded-2xl animate-fadeInUp",useGlassEffect:!0,children:[e.jsxs("div",{className:"border-b border-[var(--color-border-default)] pb-6 mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] leading-tight tracking-tight line-clamp-3",title:t.title,children:e.jsx(F,{text:t.title,markdownFormatting:!0})}),e.jsx(d,{variant:"outline",size:"sm",onClick:_,leftIcon:S?e.jsx($,{className:"w-4 h-4 text-[var(--color-success-accent)]"}):e.jsx(K,{className:"w-4 h-4"}),className:`!py-2 px-4 rounded-lg shadow-sm flex-shrink-0 ${S?"!border-[var(--color-success-accent)] !text-[var(--color-success-accent)]":"!border-[var(--color-border-interactive)] hover:!border-[var(--color-primary-accent)]"}`,children:s(S?"copied":"copyShareLink")})]}),((E=t.creator)==null?void 0:E.name)&&e.jsxs("div",{className:"flex items-center text-sm text-[var(--color-text-secondary)] mt-3",children:[e.jsx(R,{className:"w-4 h-4 mr-2 text-[var(--color-text-muted)]"}),e.jsxs("span",{children:[s("dashboardQuizCardCreated",{date:""})," ",t.creator.name]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex justify-between items-center mb-5",children:e.jsx("h2",{className:"text-xl font-semibold text-[var(--color-text-primary)]",children:s("quizDetails")})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 text-center sm:text-left mb-4",children:[e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsx("p",{className:"text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1",children:s("numberOfQuestions")}),e.jsx("p",{className:"text-2xl font-bold text-[var(--color-text-primary)]",children:t.questions.length})]}),e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsx("p",{className:"text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1",children:s("difficulty")}),e.jsx("p",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:Y})]}),e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsx("p",{className:"text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1",children:s("step2LanguageLabel")}),e.jsx("p",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:V})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-center sm:text-left",children:[e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/30 p-3 rounded-lg border border-[var(--color-border-default)]/50",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--color-text-muted)] mb-1",children:"Created"}),e.jsx("p",{className:"text-sm text-[var(--color-text-primary)]",children:B})]}),e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/30 p-3 rounded-lg border border-[var(--color-border-default)]/50",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--color-text-muted)] mb-1",children:"Last Modified"}),e.jsx("p",{className:"text-sm text-[var(--color-text-primary)]",children:G})]})]}),t.sourceContentSnippet&&e.jsxs("div",{className:"mt-4 bg-[var(--color-bg-surface-2)]/30 p-4 rounded-lg border border-[var(--color-border-default)]/50",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--color-text-muted)] mb-2",children:"Source Content"}),e.jsx("p",{className:"text-sm text-[var(--color-text-secondary)] line-clamp-3",children:t.sourceContentSnippet})]})]}),t.questions&&t.questions.length>0&&e.jsxs("div",{className:"mb-10",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--color-text-primary)] mb-5",children:s("previewQuestions")}),e.jsx("div",{className:"space-y-4",children:t.questions.slice(0,3).map((o,c)=>e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 sm:p-5 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsxs("div",{className:"font-medium text-[var(--color-text-primary)] mb-2 text-sm sm:text-base",children:[e.jsxs("span",{className:"text-[var(--color-primary-accent)] mr-2 font-semibold",children:[c+1,"."]}),e.jsx(F,{text:o.questionText,markdownFormatting:!0})]}),c===2&&t.questions.length>3&&e.jsx("p",{className:"text-xs text-[var(--color-text-muted)] italic text-center mt-3",children:s("andMoreQuestions",{count:t.questions.length-3})}),c<2&&t.questions.length>1&&e.jsx("p",{className:"text-xs text-[var(--color-text-muted)] italic mt-2",children:s("moreQuestionsInQuiz")})]},o.id))})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center items-center gap-4 pt-6 border-t border-[var(--color-border-default)]",children:[e.jsx(d,{variant:"primary",size:"lg",onClick:H,leftIcon:e.jsx(ee,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-10 rounded-xl bg-gradient-to-r from-[var(--color-primary-accent)] to-indigo-500 hover:from-[var(--color-primary-accent-hover)] hover:to-indigo-600 shadow-xl",children:s("takeQuizNow")}),i&&!w()&&e.jsx(d,{variant:"outline",size:"lg",onClick:U,disabled:D,leftIcon:e.jsx(te,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-8 rounded-xl border-green-500/50 text-green-600 hover:bg-green-50 hover:border-green-500 dark:border-green-400/50 dark:text-green-400 dark:hover:bg-green-900/20",children:D?"Saving...":"Save Quiz"}),i&&w()&&e.jsx(d,{variant:"outline",size:"lg",disabled:!0,leftIcon:e.jsx($,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-8 rounded-xl border-green-500/50 text-green-600 bg-green-50 dark:border-green-400/50 dark:text-green-400 dark:bg-green-900/20",children:"Already Saved"}),e.jsx(d,{variant:"outline",size:"lg",onClick:()=>m("/create"),leftIcon:e.jsx(se,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-8 rounded-xl",children:s("createQuiz")})]})]}),t&&e.jsx("div",{className:"mt-6",children:e.jsx(oe,{quizId:t.id,isOwner:(i==null?void 0:i.id)===t.userId,currentUserId:i==null?void 0:i.id})})]})};le.displayName="SharedQuizPage";export{le as default};
