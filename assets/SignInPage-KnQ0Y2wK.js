import{j as r}from"./ui-BGuvgkTr.js";import{u as b,b as L,R as v}from"./router-BxjC687J.js";import{u as k,c as j,l as o,J as C,C as N,K as G,B as A}from"./index-D0z0V3bW.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const E={},_=()=>{const{login:x,currentUser:I}=k(),{t:g}=j(),d=b(),u=L(),S=void 0;v.useEffect(()=>{var e,s;if(I){const c=((s=(e=u.state)==null?void 0:e.from)==null?void 0:s.pathname)||"/dashboard";o.info("User already signed in, redirecting.","SignInPage",{from:c}),d(c,{replace:!0})}},[I,d,u.state]),v.useEffect(()=>{console.log("üîç SignInPage loaded, GoogleLogin component should be available"),o.info("SignInPage loaded - checking Google OAuth setup","SignInPage",{hasGoogleOAuth:!!window.google,hasGoogleScript:!!document.querySelector('script[src*="accounts.google.com"]')})},[]);const t=e=>{o.error("Google Login Failed.","SignInPage",{errorDetails:e})},w=async e=>{var s,c,i;if(o.info("üéâ GoogleLogin SUCCESS - ID token received!","SignInPage",{hasCredential:!!e.credential,credentialLength:((s=e.credential)==null?void 0:s.length)||0}),e.credential)try{const p=e.credential.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),f=decodeURIComponent(atob(p).split("").map(function(l){return"%"+("00"+l.charCodeAt(0).toString(16)).slice(-2)}).join("")),n=JSON.parse(f);o.info("ID token decoded successfully","SignInPage",{userId:n.sub,email:n.email});const h={id:n.sub,name:n.name,email:n.email,imageUrl:n.picture,accessToken:e.credential,idToken:e.credential};o.info("User profile created from ID token. Calling login context function.","SignInPage",{userId:h.id,hasIdToken:!0});try{const l=await x(h);if(l){o.info("Login completed successfully, redirecting...","SignInPage",{userId:l.id});const y=((i=(c=u.state)==null?void 0:c.from)==null?void 0:i.pathname)||"/dashboard";d(y,{replace:!0})}else o.error("Login returned null result","SignInPage"),t(new Error("Login failed - no user returned"))}catch(l){o.error("Login process failed","SignInPage",void 0,l),t(l)}}catch(a){o.error("Error during credential processing or login","SignInPage",void 0,a),t(a)}else o.error("Credential response received but no credential token","SignInPage",{credentialResponse:e}),t(e)},m=C({onSuccess:async e=>{var s,c;if(o.info("Google Login Succeeded (token obtained).","SignInPage",{hasAccessToken:!!e.access_token}),e.access_token)try{const i=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!i.ok){const n=await i.json().catch(()=>({message:"Failed to parse error response from userinfo endpoint"}));o.error("Failed to fetch user info from Google.","SignInPage",{status:i.status,errorData:n}),t(n);return}const a=await i.json(),p=a.picture?a.picture.replace(/=s\d+-c$/,"=s256-c"):a.picture,f={id:a.sub,name:a.name,email:a.email,imageUrl:p,accessToken:e.access_token};o.info("User info fetched successfully. Calling login context function.","SignInPage",{userId:f.id});try{const n=await x(f,e);if(n){o.info("Login completed successfully, redirecting...","SignInPage",{userId:n.id});const h=((c=(s=u.state)==null?void 0:s.from)==null?void 0:c.pathname)||"/dashboard";d(h,{replace:!0})}else o.error("Login returned null result","SignInPage"),t(new Error("Login failed - no user returned"))}catch(n){o.error("Login process failed","SignInPage",void 0,n),t(n)}}catch(i){o.error("Error during token validation, fetching user info, or login process.","SignInPage",void 0,i),t(i)}else o.error("Login success callback, but no access_token in tokenResponse.","SignInPage",{tokenResponse:e}),t(e)},onError:t,scope:"email profile https://www.googleapis.com/auth/drive.file"}),P=()=>{if(o.info("‚ö†Ô∏è  FALLBACK Google Login button clicked - this will use access token only!","SignInPage"),console.warn("üî∏ User clicked FALLBACK authentication - quiz sharing will NOT work!"),!S){o.warn("VITE_RECAPTCHA_SITE_KEY is not configured. Proceeding with login directly.","SignInPage"),m();return}if(typeof grecaptcha>"u"||typeof grecaptcha.enterprise>"u"||typeof grecaptcha.enterprise.ready!="function"){o.warn("reCAPTCHA enterprise.js not loaded or not ready. Proceeding with login directly.","SignInPage"),m();return}grecaptcha.enterprise.ready(async()=>{try{const e=await grecaptcha.enterprise.execute(S,{action:"LOGIN"});o.info("reCAPTCHA token obtained for LOGIN action.","SignInPage",{tokenPreview:e.slice(0,10)+"..."}),m()}catch(e){o.error("L·ªói khi th·ª±c thi reCAPTCHA (token generation):","SignInPage",void 0,e),m()}})};return r.jsx("div",{className:"flex flex-col items-center justify-center min-h-[calc(100vh-250px)] py-10 sm:py-16",children:r.jsxs(N,{className:"max-w-md w-full text-center shadow-2xl p-8 sm:p-10 md:p-12 !rounded-2xl",useGlassEffect:!0,children:[r.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-4 mt-8 sm:mt-10",children:g("signInTitle")}),r.jsx("p",{className:"text-[var(--color-text-secondary)] mb-10 text-sm",children:g("signInSubtitle")}),r.jsxs("div",{className:"flex flex-col items-center space-y-4 mb-8",children:[r.jsxs("div",{className:"w-full max-w-xs sm:w-[280px]",children:[r.jsx("div",{className:"text-sm font-medium text-[var(--color-primary-accent)] text-center mb-2",children:"‚ú® Recommended: Full Features"}),r.jsx(G,{onSuccess:w,onError:()=>{o.error("GoogleLogin component failed","SignInPage"),t("Google Login component failed")},useOneTap:!1,shape:"rectangular",theme:"outline",size:"large",text:"signin_with",width:"280",locale:"en"})]}),r.jsxs("div",{className:"w-full max-w-xs sm:w-[280px]",children:[r.jsx("div",{className:"text-xs text-[var(--color-text-muted)] text-center mb-2",children:"‚ö†Ô∏è Limited Features (Quiz sharing won't work)"}),r.jsx(A,{onClick:P,variant:"subtle",size:"sm",leftIcon:r.jsx("img",{src:"https://img.icons8.com/color/48/google-logo.png",alt:"Google",className:"w-4 h-4"}),className:"w-full !justify-start !text-[var(--color-text-secondary)] hover:!bg-[var(--color-bg-surface-2)] !border-[var(--color-border-subtle)] hover:!border-[var(--color-border-interactive)] !px-3 !py-2 !rounded-md shadow-sm",children:r.jsx("span",{className:"ml-2 text-xs font-medium",children:"Google (Fallback)"})})]})]}),r.jsxs("p",{className:"text-xs text-[var(--color-text-muted)]",children:[g("signInAgreementPrompt")," "," ",r.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:g("footerTerms")})," ",g("and")," "," ",r.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:g("footerPrivacy")}),"."]})]})})};_.displayName="SignInPage";export{_ as default};
