import{r as e,j as t}from"./core-react-DcE6uGcR.js";import{a as s,u as i,L as r,B as a,C as n,r as o,o as l,M as c}from"./app-components-CFPFxe5x.js";import{u}from"./feature-quiz-hooks-BfRW88BL.js";import{P as d,b as m}from"./feature-quiz-components-CChsAlA6.js";import{l as p,c as x}from"./services-BHj8px4z.js";import{d as f,a as g}from"./router-Dk7yDelZ.js";import"./katex-core-BbYO2yyT.js";import"./katex-extras-AZS8NW-4.js";import"./service-supabase-wASzC9XA.js";import"./google-services-Bc_loC93.js";/* empty css                        */import"./feature-quiz-home-Ch5jepSG.js";import"./ui-framework-CdNWeEQR.js";import"./feature-quiz-dashboard-C8yrEGC7.js";import"./markdown-processors-D3jN8hOQ.js";import"./react-markdown-Cej2CoYR.js";import"./feature-quiz-sharedquiz-Clu9xfzS.js";import"./feature-quiz-2SquOiTn.js";import"./util-storage-UFVse9kk.js";import"./util-document-Dv5rbOR1.js";import"./util-pdf-CkIVnOzu.js";const j=()=>{const{t:j}=s(),{quizId:h}=f(),z=g(),{setQuizResult:q,currentUser:C}=i(),[v,b]=e.useState(null),[k,w]=e.useState(!1),[y,P]=e.useState(null),[N,T]=e.useState([]),[I,Q]=e.useState(!1),[O,S]=e.useState(!1),A=e.useRef(!1),E=e.useCallback(()=>{A.current||Q(!0)},[]),{localActiveQuiz:L,currentQuestion:U,currentQuestionIndex:M,loading:D,timeLeft:R,elapsedTime:B,goToNextQuestion:F,goToPreviousQuestion:G,formatTime:$,totalQuestions:H,shuffledQuestions:J,attemptSettings:K,markQuizCompleted:V,updateUserAnswer:W,userAnswers:X}=u(h,E);e.useEffect(()=>{if(J.length>0&&0===N.length){const e=J.map(e=>{const t=X[e.id],s=t?t===e.correctAnswer:null;return{questionId:e.id,selectedOption:t||null,isCorrect:t?s:null,firstTryCorrect:t?s:null,attempts:t?1:0}});T(e)}},[J,N.length,X]),e.useEffect(()=>{if(A.current)return;let e=null,t=!1,s=null;if(U&&N.length>0){const i=N.find(e=>e.questionId===U.id);i&&(e=i.selectedOption,null!==i.isCorrect&&(t=!0,s=i.isCorrect))}b(e),w(t),P(s),S(!1)},[M,U,N]),e.useEffect(()=>{(null==C?void 0:C.id)&&N.forEach(e=>{e.selectedOption&&null!==e.isCorrect&&W(e.questionId,e.selectedOption)})},[N,W,null==C?void 0:C.id]);const Y=e.useCallback(async()=>{if(A.current||!L)return;A.current=!0,S(!0),p.info("Starting practice finish process","QuizPracticePage",{quizId:L.id,currentTime:B});let e=[...N];U&&v&&!k&&(e=e.map(e=>e.questionId===U.id?{...e,selectedOption:v,isCorrect:null,attempts:e.attempts||0}:e)),await V();const t=e.filter(e=>!0===e.isCorrect).length,s=e.map(e=>({questionId:e.questionId,answer:e.selectedOption||""})),i=L.questions.length>0?t/L.questions.length*100:0,r={quizId:L.id,score:parseFloat(i.toFixed(2)),answers:s,totalCorrect:t,totalQuestions:L.questions.length,timeTaken:Math.max(1,B),sourceMode:"practice",createdAt:(new Date).toISOString()};if(p.info("Submitting practice result","QuizPracticePage",{quizId:L.id,elapsedTime:B,timeTaken:r.timeTaken}),q(r),C)try{const e=await x.saveQuizResult(r);e?p.info("Practice result saved to database successfully","QuizPracticePage",{resultId:e}):p.info("Practice result not saved to database (user not authenticated)","QuizPracticePage")}catch(a){p.error("Error saving practice result","QuizPracticePage",{},a)}else p.info("No user logged in, practice result saved locally only","QuizPracticePage");z(`/results/${L.id}`)},[L,N,U,v,k,q,K.timeLimit,R,z,C,B,V]),Z=e.useCallback(()=>{L&&U&&!A.current&&!O&&(S(!0),v&&!k?T(e=>e.map(e=>e.questionId!==U.id||e.selectedOption===v&&null!==e.isCorrect?e:{...e,selectedOption:v,isCorrect:e.isCorrect,attempts:e.attempts||0})):v||k||T(e=>e.map(e=>e.questionId===U.id&&null!==e.selectedOption&&null===e.isCorrect?{...e,selectedOption:null}:e)),F()||Y())},[L,U,F,Y,v,k,O]),_=e.useCallback(()=>{L&&U&&!A.current&&!O&&(S(!0),F()||Y())},[L,U,F,Y,O]),ee=e.useCallback(()=>{!U||A.current||O||(S(!0),v&&!k?T(e=>e.map(e=>e.questionId!==U.id||e.selectedOption===v&&null!==e.isCorrect?e:{...e,selectedOption:v,isCorrect:e.isCorrect,attempts:e.attempts||0})):v||k||T(e=>e.map(e=>e.questionId===U.id&&null!==e.selectedOption&&null===e.isCorrect?{...e,selectedOption:null}:e)),G())},[G,v,k,U,O]),te=e.useCallback(()=>{Y()},[Y]);if(O&&A.current)return t.jsx("div",{className:"flex flex-col items-center justify-center p-8 min-h-[400px]",children:t.jsx(r,{text:j("quizPracticeEnding")||"Processing...",size:"lg"})});if(D||!L)return t.jsx(r,{text:j("quizTakingLoading"),className:"mt-24",size:"xl"});if(!U)return L&&H>0&&M>=H?(A.current||Y(),t.jsx("div",{className:"flex flex-col items-center justify-center p-8 min-h-[400px]",children:t.jsx(r,{text:j("quizPracticeEnding")||"Completing practice...",size:"lg"})})):D?t.jsx(r,{text:j("quizTakingLoading"),className:"mt-24",size:"xl"}):t.jsxs("div",{className:"flex flex-col items-center justify-center p-8 min-h-[400px]",children:[t.jsx(r,{text:j("error")+" - "+(j("quizTakingLoading")||"Processing..."),size:"lg"}),t.jsx(a,{onClick:()=>z("/dashboard"),className:"mt-4",children:j("resultsGoToDashboard")})]});const se=M===H-1;return t.jsxs(n,{className:"max-w-2xl mx-auto shadow-2xl !rounded-2xl animate-page-slide-fade-in p-5 sm:p-6",useGlassEffect:!0,children:[t.jsxs("div",{className:"mb-6 sm:mb-8",children:[t.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-[var(--color-text-primary)] mb-3 leading-tight tracking-tight line-clamp-2",title:L.title,children:j("quizPracticeTitle",{quizTitle:L.title})}),t.jsxs("div",{className:"flex justify-between items-center text-xs text-[var(--color-text-secondary)] mb-2",children:[t.jsxs("span",{className:"font-semibold text-[var(--color-text-muted)]",children:["Time: ",$(B)]}),""!==K.timeLimit&&null!==R&&t.jsx("span",{className:"font-semibold "+(R<=60?"text-red-400 animate-pulse":"text-[var(--color-primary-accent)]"),children:j("quizTakingTimeLeft",{time:$(R)})})]})]}),U?t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"question-wrapper",onClick:e=>{e.currentTarget.querySelectorAll("a").length>0&&(e.preventDefault(),e.stopPropagation())},children:t.jsx(d,{question:U.questionText,options:U.options,currentIndex:M,totalQuestions:H,selectedOption:v,onSelectOption:e=>{k||A.current||O||b(e)},onCheckAnswer:()=>{if(!v||!U||A.current||O)return;S(!0);const e=v===U.correctAnswer;w(!0),P(e),T(t=>t.map(t=>t.questionId===U.id?{...t,selectedOption:v,isCorrect:e,attempts:(t.attempts||0)+1,...0===(t.attempts||0)&&{firstTryCorrect:e}}:t)),(null==C?void 0:C.id)&&W(U.id,v)},onSkipQuestion:_,isSubmitting:O,isAnswerChecked:k,isAnswerCorrect:y,correctAnswer:U.correctAnswer})}),k&&t.jsx(m,{explanation:U.explanation||j("resultsNoExplanation")})]}):null,t.jsxs("div",{className:"quiz-navigation-actions mt-6 pt-6 border-t border-[var(--color-border-default)] flex flex-col sm:flex-row sm:justify-between gap-3",children:[t.jsx(a,{variant:"secondary",onClick:ee,disabled:O||0===M,size:"md",leftIcon:t.jsx(o,{className:"w-4 h-4"}),className:"w-full sm:w-auto",children:j("previous")}),t.jsx(a,{variant:se&&k?"primary":"secondary",onClick:k?Z:Y,disabled:O,size:"md",rightIcon:t.jsx(l,{className:"w-4 h-4"}),className:"w-full sm:w-auto",children:j(k?se?"finishPractice":"nextQuestion":"finishPractice")})]}),I&&t.jsx(c,{isOpen:I&&!A.current,onClose:te,title:j("timesUp"),size:"md",hideCloseButton:!0,footerContent:t.jsx("div",{className:"flex justify-center",children:t.jsx(a,{variant:"primary",onClick:te,size:"md",children:j("timesUpSubmit")})}),children:t.jsx("p",{className:"text-[var(--color-text-body)] text-base leading-relaxed text-center",children:j("timesUpMessage")})})]})};j.displayName="QuizPracticePage";export{j as default};
