import{j as e}from"./ui-BGuvgkTr.js";import{f as K,u as V,r as o}from"./router-BxjC687J.js";import{u as W,c as X,s as Y,L as M,C as U,M as y,P as Z,B as m,j as _,e as ee,k as B}from"./index-D-q-H-sx.js";import{u as se}from"./useQuizFlow-CbKTm0dc.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const te=()=>{const{setQuizResult:w,currentUser:f}=W(),{t}=X(),{quizId:L}=K(),z=V(),[l,k]=o.useState({}),[r,v]=o.useState(null),[N,p]=o.useState(!1),[S,T]=o.useState(!1),F=o.useCallback(()=>{T(!0)},[]),{localActiveQuiz:i,currentQuestion:s,currentQuestionIndex:b,loading:P,timeLeft:x,goToNextQuestion:O,goToPreviousQuestion:$,formatTime:E,totalQuestions:c,attemptSettings:h}=se(L,F);o.useEffect(()=>{s&&l[s.id]?v(l[s.id]):v(null)},[s,l]);const R=a=>{v(a)},Q=o.useCallback(()=>{s&&r?k(a=>({...a,[s.id]:r})):s&&!r&&l[s.id]&&k(a=>{const d={...a};return delete d[s.id],d})},[s,r,l]),j=o.useCallback(async()=>{if(!i)return;let a={...l};s&&r?a[s.id]=r:s&&!r&&a[s.id]&&delete a[s.id];let d=0;const u=[];i.questions.forEach(n=>{const g=a[n.id];g?(u.push({questionId:n.id,answer:g}),g===n.correctAnswer&&d++):u.push({questionId:n.id,answer:""})});const A=c>0?d/c*100:0,C={quizId:i.id,score:parseFloat(A.toFixed(2)),answers:u,totalCorrect:d,totalQuestions:c,timeTaken:h.timeLimit>0?h.timeLimit*60-(x||0):void 0,sourceMode:"take",createdAt:new Date().toISOString()};if(w(C),f)try{const n=await Y.saveQuizResult(C,f.id,f);console.log(n?"Quiz result saved to database successfully":"Quiz result not saved to database (user not authenticated with Supabase, using local storage only)")}catch(n){console.error("Failed to save quiz result to database:",n)}else console.log("No user logged in, quiz result saved locally only");p(!1),T(!1),z(`/results/${i.id}`)},[i,l,s,r,x,w,z,c,h.timeLimit,f]),D=()=>{i&&(Q(),O()||p(!0))},G=()=>{Q(),$()},I=o.useCallback(()=>p(!1),[]),q=o.useCallback(()=>{j()},[j]);if(P||!i)return e.jsx(M,{text:t("quizTakingLoading"),className:"mt-24",size:"xl"});if(!s)return e.jsxs(U,{className:"max-w-3xl mx-auto p-5 sm:p-6 md:p-8 animate-fadeInUp rounded-lg bg-[var(--color-bg-surface-2)]/50 border border-[var(--color-border-default)] shadow-md",children:[e.jsx(M,{text:t("quizTakingLoading")}),e.jsx("p",{className:"text-center text-[var(--color-text-secondary)] mt-4",children:t("quizTakingErrorQuestionNotFound")})]});const H=c>0?(b+1)/c*100:0,J=b===c-1;return e.jsxs(U,{className:"max-w-3xl mx-auto p-5 sm:p-6 md:p-8 animate-fadeInUp rounded-lg bg-[var(--color-bg-surface-2)]/50 border border-[var(--color-border-default)] shadow-md",children:[e.jsxs("div",{className:"mb-6 sm:mb-8",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-3 sm:mb-4 leading-tight tracking-tight line-clamp-2",title:i.title,children:e.jsx(y,{text:i.title,markdownFormatting:!0})}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-[var(--color-text-secondary)] mb-4 sm:mb-5",children:[e.jsx("span",{children:t("quizTakingQuestionProgress",{current:b+1,total:c})}),x!==null&&e.jsx("span",{className:`font-semibold ${x<=60?"text-red-400 animate-pulse":"text-[var(--color-primary-accent)]"}`,children:t("quizTakingTimeLeft",{time:E(x)})})]}),e.jsx(Z,{progress:H,size:"md"})]}),e.jsxs("div",{className:"mt-6 md:mt-8",children:[e.jsx("div",{className:"quiz-question-text text-base sm:text-lg text-[var(--color-text-body)] leading-relaxed mb-4",children:e.jsx(y,{text:s.questionText,markdownFormatting:!0})}),e.jsx("div",{className:"quiz-options space-y-3",children:s.options.map((a,d)=>{const u=r===a;return e.jsxs("button",{onClick:()=>R(a),className:`w-full flex items-center text-left p-3.5 sm:p-4 rounded-xl border-2 focus:outline-none focus-visible:ring-4 focus-visible:ring-[var(--color-primary-accent)]/50 focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--color-bg-default)] shadow-lg transition-all var(--duration-fast) var(--ease-ios) will-change-transform, border, background-color ${u?"bg-[var(--color-primary-accent)]/50 border-[var(--color-primary-accent)] text-[var(--color-primary-accent-text)] font-semibold scale-[1.01]":"bg-[var(--color-bg-surface-3)]/70 hover:bg-[var(--color-bg-surface-3)]/40 border-[var(--color-border-interactive)] hover:border-[var(--color-primary-accent)] text-[var(--color-text-primary)]"}`,"aria-pressed":u,children:[e.jsx("span",{className:`option-indicator mr-3.5 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors var(--duration-fast) var(--ease-ios) ${u?"border-[var(--color-primary-accent-text)] bg-[var(--color-primary-accent)]":"border-[var(--color-text-muted)] bg-[var(--color-bg-surface-2)] group-hover:border-[var(--color-primary-accent)]"}`}),e.jsx("div",{className:"text-sm sm:text-base flex-grow markdown-content",children:e.jsx(y,{text:a,markdownFormatting:!0})})]},d)})})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pt-6 sm:pt-8 border-t border-[var(--color-border-default)] mt-6 sm:mt-8",children:[e.jsx(m,{onClick:D,disabled:!r&&!(s&&l[s.id]),variant:"primary",size:"lg",rightIcon:e.jsx(_,{className:"w-5 h-5"}),className:"w-full py-3 rounded-xl",children:t(J?"submit":"nextQuestion")}),e.jsxs("div",{className:"flex justify-between items-center pt-3",children:[e.jsx(m,{onClick:G,disabled:b===0,variant:"outline",size:"md",leftIcon:e.jsx(ee,{className:"w-4 h-4"}),className:"py-2.5 px-5 rounded-lg",children:t("previous")}),e.jsx(m,{onClick:()=>p(!0),variant:"outline",size:"md",className:"py-2.5 px-5 rounded-lg",children:t("quizTakingSubmitQuiz")})]})]}),N&&e.jsx(B,{isOpen:N,onClose:I,title:t("quizTakingSubmitQuiz"),size:"md",footerContent:e.jsxs("div",{className:"flex justify-end gap-3.5",children:[e.jsx(m,{variant:"secondary",onClick:I,size:"md",children:t("cancel")}),e.jsx(m,{variant:"primary",onClick:j,size:"md",children:t("submit")})]}),children:e.jsx("p",{className:"text-[var(--color-text-body)] text-base leading-relaxed",children:t("submitConfirmationMessage")})}),S&&e.jsx(B,{isOpen:S,onClose:q,title:t("timesUp"),size:"md",hideCloseButton:!0,footerContent:e.jsx("div",{className:"flex justify-center",children:e.jsx(m,{variant:"primary",onClick:q,size:"md",children:t("timesUpSubmit")})}),children:e.jsx("p",{className:"text-[var(--color-text-body)] text-base leading-relaxed text-center",children:t("timesUpMessage")})})]})};te.displayName="QuizTakingPage";export{te as default};
