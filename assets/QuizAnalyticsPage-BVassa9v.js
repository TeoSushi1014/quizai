import{j as e}from"./ui-BGuvgkTr.js";import{f as I,u as A,r as l}from"./router-BxjC687J.js";import{u as Q,l as n,K as k,L as C,C as i,B as y,e as D}from"./index-B_-v24kb.js";import{q as g}from"./quizResultsService-iXRuJ6ay.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const F=()=>{const{quizId:a}=I(),{currentUser:s}=Q(),d=A(),[r,f]=l.useState(null),[u,b]=l.useState([]),[c,z]=l.useState({totalAttempts:0,averageScore:0,bestScore:0,averageTime:0,uniqueUsers:0}),[S,p]=l.useState(!0),[j,v]=l.useState(null);l.useEffect(()=>{if(!s||!a){d("/");return}w()},[s,a,d]);const w=async()=>{if(!(!a||!s))try{p(!0),n.info("Loading quiz analytics","QuizAnalyticsPage",{quizId:a});const t=await k.getQuizById(a);if(!t){v("Quiz not found or you do not have permission to view it");return}f(t);const h=await g.getQuizStats(a);z(h);const o=t.userId===s.id;n.info("Loading quiz history with ownership check","QuizAnalyticsPage",{quizId:a,isOwner:o,quizOwnerId:t.userId,currentUserId:s.id,userIdFilter:o?void 0:s.id});const x=await g.getQuizHistory({quizId:a,userId:o?void 0:s.id,limit:50});n.info("Quiz history results","QuizAnalyticsPage",{quizId:a,resultsCount:x.length,results:x.map(m=>({id:m.id,userId:m.user_id,userName:m.user_name,score:m.score}))}),b(x),n.info("Quiz analytics loaded successfully","QuizAnalyticsPage",{quizId:a,resultsCount:x.length})}catch(t){n.error("Failed to load quiz analytics","QuizAnalyticsPage",{},t),v("Failed to load quiz analytics")}finally{p(!1)}},N=t=>{if(!t)return"N/A";const h=Math.floor(t/60),o=t%60;return`${h}m ${o}s`},q=t=>t>=80?"text-green-600 dark:text-green-400":t>=60?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";return!s||!a?null:S?e.jsx("div",{className:"flex justify-center items-center min-h-[calc(100vh-200px)]",children:e.jsx(C,{size:"xl",text:"Loading analytics..."})}):j?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs(i,{className:"max-w-md mx-auto p-8 text-center",children:[e.jsx("p",{className:"text-red-600 mb-4",children:j}),e.jsx(y,{onClick:()=>d("/dashboard"),children:"Back to Dashboard"})]})}):e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-6xl",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx(y,{variant:"outline",onClick:()=>d("/dashboard"),leftIcon:e.jsx(D,{className:"w-4 h-4"}),className:"mb-4",children:"Back to Dashboard"}),e.jsx("h1",{className:"text-3xl font-bold text-[var(--color-text-primary)] mb-2",children:"Quiz Analytics"}),r&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl text-[var(--color-text-secondary)] mb-2",children:r.title}),e.jsx("p",{className:"text-sm text-[var(--color-text-muted)]",children:r.userId===(s==null?void 0:s.id)?"Showing all attempts from everyone who took this quiz":"Showing your attempts only"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8",children:[e.jsxs(i,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-[var(--color-primary-accent)]",children:c.totalAttempts}),e.jsx("div",{className:"text-sm text-[var(--color-text-muted)]",children:"Total Attempts"})]}),e.jsxs(i,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-[var(--color-primary-accent)]",children:c.uniqueUsers}),e.jsx("div",{className:"text-sm text-[var(--color-text-muted)]",children:"Unique Users"})]}),e.jsxs(i,{className:"p-4 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-[var(--color-primary-accent)]",children:[c.averageScore,"%"]}),e.jsx("div",{className:"text-sm text-[var(--color-text-muted)]",children:"Average Score"})]}),e.jsxs(i,{className:"p-4 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-[var(--color-primary-accent)]",children:[c.bestScore,"%"]}),e.jsx("div",{className:"text-sm text-[var(--color-text-muted)]",children:"Best Score"})]}),e.jsxs(i,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-[var(--color-primary-accent)]",children:N(c.averageTime)}),e.jsx("div",{className:"text-sm text-[var(--color-text-muted)]",children:"Avg Time"})]})]}),e.jsxs(i,{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-semibold mb-6",children:"Detailed Results"}),r&&e.jsxs("div",{className:"mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded text-sm",children:[e.jsx("p",{children:e.jsx("strong",{children:"Debug Info:"})}),e.jsxs("p",{children:["Quiz ID: ",r.id]}),e.jsxs("p",{children:["Quiz Owner: ",r.userId]}),e.jsxs("p",{children:["Current User: ",s==null?void 0:s.id]}),e.jsxs("p",{children:["Is Owner: ",r.userId===(s==null?void 0:s.id)?"Yes":"No"]}),e.jsxs("p",{children:["Results Count: ",u.length]}),e.jsxs("p",{children:["Filter Applied: ",r.userId===(s==null?void 0:s.id)?"None (show all)":"Current user only"]})]}),u.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-[var(--color-text-muted)]",children:"No attempts yet. Share your quiz to get started!"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-[var(--color-border-default)]",children:[e.jsx("th",{className:"text-left py-3 px-2",children:"User"}),e.jsx("th",{className:"text-left py-3 px-2",children:"Score"}),e.jsx("th",{className:"text-left py-3 px-2",children:"Time Taken"}),e.jsx("th",{className:"text-left py-3 px-2",children:"Date"})]})}),e.jsx("tbody",{children:u.map(t=>e.jsxs("tr",{className:"border-b border-[var(--color-border-default)] hover:bg-[var(--color-bg-surface-2)]",children:[e.jsx("td",{className:"py-3 px-2",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.user_name||"Anonymous User"}),t.user_email&&e.jsx("div",{className:"text-sm text-[var(--color-text-muted)]",children:t.user_email})]})}),e.jsxs("td",{className:"py-3 px-2",children:[e.jsxs("span",{className:`font-semibold ${q(t.score)}`,children:[t.score,"%"]}),e.jsxs("div",{className:"text-sm text-[var(--color-text-muted)]",children:[Math.round(t.score/100*t.total_questions),"/",t.total_questions]})]}),e.jsx("td",{className:"py-3 px-2",children:N(t.time_taken)}),e.jsxs("td",{className:"py-3 px-2",children:[e.jsx("div",{className:"text-sm",children:new Date(t.created_at).toLocaleDateString()}),e.jsx("div",{className:"text-xs text-[var(--color-text-muted)]",children:new Date(t.created_at).toLocaleTimeString()})]})]},t.id))})]})})]})]})};export{F as default};
