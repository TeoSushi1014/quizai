import{l as i,a3 as c,a4 as z}from"./index-D1WZoZJd.js";class _{async saveQuizResult(e){try{i.info("Saving quiz result to database","QuizResultsService",{quizId:e.quizId,score:e.score,totalQuestions:e.totalQuestions,userId:e.userId});const{data:{user:t}}=await c.auth.getUser();!t&&e.userId&&i.warn("No authenticated user but userId provided, attempting to save anyway","QuizResultsService",{providedUserId:e.userId});const r=(t==null?void 0:t.id)||e.userId||null,{data:o,error:u}=await c.from("quiz_results").insert([{user_id:r,quiz_id:e.quizId,score:e.score,total_questions:e.totalQuestions,answers:e.answers||[],time_taken:e.timeTaken||null,created_at:new Date().toISOString()}]).select().single();return u?(i.error("Failed to save quiz result","QuizResultsService",{error:u.message,code:u.code,effectiveUserId:r,hasAuth:!!t}),null):(i.info("Quiz result saved successfully","QuizResultsService",{resultId:o.id,quizId:e.quizId,effectiveUserId:r}),o.id)}catch(t){return i.error("Error saving quiz result","QuizResultsService",{},t),null}}async getQuizHistory(e){try{i.info("Fetching quiz history","QuizResultsService",{quizId:e.quizId,userId:e.userId,limit:e.limit});const{data:{user:t}}=await c.auth.getUser();t||i.warn("No authenticated user for quiz history fetch - RLS may restrict results","QuizResultsService");let r=c.from("quiz_results").select(`
          id,
          user_id,
          quiz_id,
          score,
          total_questions,
          answers,
          time_taken,
          created_at
        `).eq("quiz_id",e.quizId).order("created_at",{ascending:!1});e.userId?(i.info("Filtering quiz history by userId","QuizResultsService",{userId:e.userId}),r=r.eq("user_id",e.userId)):i.info("Getting all quiz history (no user filter)","QuizResultsService"),e.limit&&(r=r.limit(e.limit)),e.offset&&(r=r.range(e.offset,e.offset+(e.limit||10)-1));const{data:o,error:u}=await r;if(u)return i.error("Failed to fetch quiz history","QuizResultsService",{error:u.message,code:u.code}),[];const s=await Promise.all(o.map(async a=>{let n="Anonymous User",l=null;if(a.user_id)try{const{data:d}=await c.from("users").select("name, email").eq("id",a.user_id).single();d?(n=d.name||"User",l=d.email):i.info("User not found in public.users, might be auth-only user","QuizResultsService",{userId:a.user_id})}catch{i.warn("Could not fetch user info","QuizResultsService",{userId:a.user_id})}return{id:a.id,user_id:a.user_id,quiz_id:a.quiz_id,score:a.score,total_questions:a.total_questions,answers:a.answers,time_taken:a.time_taken,created_at:a.created_at,user_name:n,user_email:l}}));return i.info("Quiz history fetched successfully","QuizResultsService",{quizId:e.quizId,resultCount:s.length}),s}catch(t){return i.error("Error fetching quiz history","QuizResultsService",{},t),[]}}async getQuizHistoryAsOwner(e){try{if(!z)return i.warn("Service role client not available, falling back to regular client","QuizResultsService"),this.getQuizHistory(e);i.info("Fetching quiz history with service role (bypassing RLS)","QuizResultsService",{quizId:e.quizId,limit:e.limit});let t=z.from("quiz_results").select(`
          id,
          user_id,
          quiz_id,
          score,
          total_questions,
          answers,
          time_taken,
          created_at
        `).eq("quiz_id",e.quizId).order("created_at",{ascending:!1});e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||10)-1));const{data:r,error:o}=await t;if(o)return i.error("Failed to fetch quiz history with service role","QuizResultsService",{error:o.message,code:o.code}),this.getQuizHistory(e);const u=await Promise.all(r.map(async s=>{let a="Anonymous User",n=null;if(s.user_id&&z)try{const{data:l}=await z.from("users").select("name, email").eq("id",s.user_id).single();l&&(a=l.name||"User",n=l.email)}catch{i.warn("Could not fetch user info with service role","QuizResultsService",{userId:s.user_id})}return{id:s.id,user_id:s.user_id,quiz_id:s.quiz_id,score:s.score,total_questions:s.total_questions,answers:s.answers,time_taken:s.time_taken,created_at:s.created_at,user_name:a,user_email:n}}));return i.info("Quiz history fetched successfully with service role","QuizResultsService",{quizId:e.quizId,resultCount:u.length}),u}catch(t){return i.error("Error fetching quiz history with service role","QuizResultsService",{},t),this.getQuizHistory(e)}}async getUserQuizHistory(e,t=20){try{i.info("Fetching user quiz history","QuizResultsService",{userId:e,limit:t});const{data:r,error:o}=await c.from("quiz_results").select(`
          id,
          user_id,
          quiz_id,
          score,
          total_questions,
          answers,
          time_taken,
          created_at
        `).eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(o)return i.error("Failed to fetch user quiz history","QuizResultsService",{error:o.message,code:o.code}),[];const u=await Promise.all(r.map(async s=>{let a="Unknown Quiz";if(s.quiz_id)try{const{data:n}=await c.from("quizzes").select("title").eq("id",s.quiz_id).single();n&&(a=n.title||"Untitled Quiz")}catch{i.warn("Could not fetch quiz title for user history","QuizResultsService",{quizId:s.quiz_id})}return{id:s.id,user_id:s.user_id,quiz_id:s.quiz_id,score:s.score,total_questions:s.total_questions,answers:s.answers,time_taken:s.time_taken,created_at:s.created_at,quiz_title:a}}));return i.info("User quiz history fetched successfully","QuizResultsService",{userId:e,resultCount:u.length}),u}catch(r){return i.error("Error fetching user quiz history","QuizResultsService",{},r),[]}}async getQuizStats(e){try{i.info("Fetching quiz statistics","QuizResultsService",{quizId:e});const{data:t,error:r}=await c.from("quiz_results").select("score, time_taken, user_id").eq("quiz_id",e);if(r)return i.error("Failed to fetch quiz statistics","QuizResultsService",{error:r.message,code:r.code}),{totalAttempts:0,averageScore:0,bestScore:0,averageTime:0,uniqueUsers:0};const o=t||[],u=o.map(l=>l.score),s=o.filter(l=>l.time_taken!==null).map(l=>l.time_taken),a=new Set(o.filter(l=>l.user_id).map(l=>l.user_id)),n={totalAttempts:o.length,averageScore:u.length>0?Math.round(u.reduce((l,d)=>l+d,0)/u.length):0,bestScore:u.length>0?Math.max(...u):0,averageTime:s.length>0?Math.round(s.reduce((l,d)=>l+d,0)/s.length):0,uniqueUsers:a.size};return i.info("Quiz statistics calculated","QuizResultsService",{quizId:e,...n}),n}catch(t){return i.error("Error calculating quiz statistics","QuizResultsService",{},t),{totalAttempts:0,averageScore:0,bestScore:0,averageTime:0,uniqueUsers:0}}}async getQuizResult(e){try{i.info("Fetching quiz result details","QuizResultsService",{resultId:e});const{data:t,error:r}=await c.from("quiz_results").select(`
          id,
          user_id,
          quiz_id,
          score,
          total_questions,
          answers,
          time_taken,
          created_at
        `).eq("id",e).single();if(r)return i.error("Failed to fetch quiz result details","QuizResultsService",{error:r.message,code:r.code}),null;let o="Anonymous User",u=null,s="Unknown Quiz";if(t.user_id)try{const{data:n}=await c.from("users").select("name, email").eq("id",t.user_id).single();n&&(o=n.name||"User",u=n.email)}catch{i.warn("Could not fetch user info for result","QuizResultsService",{userId:t.user_id})}if(t.quiz_id)try{const{data:n}=await c.from("quizzes").select("title").eq("id",t.quiz_id).single();n&&(s=n.title||"Untitled Quiz")}catch{i.warn("Could not fetch quiz info for result","QuizResultsService",{quizId:t.quiz_id})}const a={id:t.id,user_id:t.user_id,quiz_id:t.quiz_id,score:t.score,total_questions:t.total_questions,answers:t.answers,time_taken:t.time_taken,created_at:t.created_at,user_name:o,user_email:u,quiz_title:s};return i.info("Quiz result details fetched successfully","QuizResultsService",{resultId:e}),a}catch(t){return i.error("Error fetching quiz result details","QuizResultsService",{},t),null}}}const h=new _;export{h as q};
