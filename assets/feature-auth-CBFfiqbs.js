import{R as e,j as r}from"./core-react-DcE6uGcR.js";import{a as i}from"./google-services-Bc_loC93.js";import{u as s,a as n,C as t,B as a}from"./app-components-CFPFxe5x.js";import{l as o}from"./services-BHj8px4z.js";import{s as l}from"./service-supabase-wASzC9XA.js";import{a as c,u as d}from"./router-Dk7yDelZ.js";import"./katex-core-BbYO2yyT.js";import"./katex-extras-AZS8NW-4.js";/* empty css                        */import"./feature-quiz-home-Ch5jepSG.js";import"./feature-quiz-components-CChsAlA6.js";import"./ui-framework-CdNWeEQR.js";import"./feature-quiz-dashboard-C8yrEGC7.js";import"./markdown-processors-D3jN8hOQ.js";import"./react-markdown-Cej2CoYR.js";import"./feature-quiz-sharedquiz-Clu9xfzS.js";import"./feature-quiz-2SquOiTn.js";import"./util-storage-UFVse9kk.js";import"./util-document-Dv5rbOR1.js";import"./util-pdf-CkIVnOzu.js";const u=()=>{const{login:u,currentUser:m}=s(),{t:g}=n(),p=c(),h=d(),[f,x]=e.useState(!1);e.useEffect(()=>{var e,r;if(m){const i=(null==(r=null==(e=h.state)?void 0:e.from)?void 0:r.pathname)||"/dashboard";o.info("User already signed in, redirecting.","SignInPage",{from:i}),p(i,{replace:!0})}},[m,p,h.state]),e.useEffect(()=>{const e=async()=>{var e,r,i,s,n,t;try{const{data:a,error:c}=await l.auth.getSession();if(c)return void o.error("Error checking auth session","SignInPage",{},c);if(null==(e=a.session)?void 0:e.user){o.info("Found Supabase session","SignInPage",{user:a.session.user.id});const e={id:a.session.user.id,email:a.session.user.email,name:(null==(r=a.session.user.user_metadata)?void 0:r.full_name)||(null==(i=a.session.user.email)?void 0:i.split("@")[0]),imageUrl:null==(s=a.session.user.user_metadata)?void 0:s.avatar_url,supabaseId:a.session.user.id};if(await u(e)){const e=(null==(t=null==(n=h.state)?void 0:n.from)?void 0:t.pathname)||"/dashboard";o.info("Login successful, redirecting","SignInPage",{destination:e}),p(e,{replace:!0})}}}catch(a){o.error("Error handling auth state change","SignInPage",{},a)}};e();const{data:{subscription:r}}=l.auth.onAuthStateChange(async r=>{o.info("Auth state changed","SignInPage",{event:r}),"SIGNED_IN"===r&&await e()});return()=>{r.unsubscribe()}},[u,p,h.state]);const v=e=>{x(!1),o.error("Login Failed.","SignInPage",{errorDetails:e})};return r.jsx("div",{className:"flex flex-col items-center justify-center min-h-[calc(100vh-250px)] py-10 sm:py-16",children:r.jsxs(t,{className:"max-w-md w-full text-center shadow-2xl p-8 sm:p-10 md:p-12 !rounded-2xl",useGlassEffect:!0,children:[r.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-4 mt-8 sm:mt-10",children:g("signInTitle")}),r.jsx("p",{className:"text-[var(--color-text-secondary)] mb-10 text-sm",children:g("signInSubtitle")}),r.jsxs("div",{className:"flex flex-col items-center mb-8",children:[r.jsxs(a,{onClick:async()=>{try{x(!0),o.info("Starting Google sign-in via Supabase","SignInPage");const{data:e,error:r}=await l.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+window.location.pathname,queryParams:{access_type:"offline",prompt:"consent"}}});if(r)return o.error("Supabase OAuth error","SignInPage",{},r),void x(!1);e.url&&(o.info("Redirecting to OAuth provider","SignInPage"),window.location.href=e.url)}catch(e){o.error("Error initiating OAuth flow","SignInPage",{},e),x(!1)}},disabled:f,className:"flex items-center justify-center space-x-2 w-64 py-2.5 px-4 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 transition duration-150 mb-4",children:[r.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",children:[r.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z",fill:"#4285F4"}),r.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z",fill:"#34A853"}),r.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z",fill:"#FBBC05"}),r.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z",fill:"#EA4335"})]}),r.jsx("span",{children:f?"Đang xử lý...":g("loginWithGoogle")})]}),r.jsx("div",{className:f?"hidden":"",children:r.jsx(i,{onSuccess:async e=>{var r,i;if(e.credential)try{o.info("Received credential response from Google","SignInPage",{hasCredential:!!e.credential,credentialLength:e.credential.length});const s=e.credential.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(s).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")),t=JSON.parse(n);o.info("Decoded user info from JWT","SignInPage",{sub:t.sub,email:t.email,name:t.name});const a={id:t.sub,name:t.name,email:t.email,imageUrl:t.picture,credential:e.credential,idToken:e.credential,accessToken:void 0,tokenType:"google-oauth-credential"};if(o.info("Attempting login with user profile","SignInPage",{email:t.email}),await u(a)){const e=(null==(i=null==(r=h.state)?void 0:r.from)?void 0:i.pathname)||"/dashboard";o.info("Login successful, redirecting","SignInPage",{destination:e}),p(e,{replace:!0})}else o.error("Login returned null result","SignInPage"),v(new Error("Login failed - no user returned"))}catch(s){o.error("Error during credential processing or login","SignInPage",void 0,s),v(s)}else o.error("Credential response received but no credential token","SignInPage",{credentialResponse:e}),v(e)},onError:v,useOneTap:!1,shape:"rectangular",theme:"outline",size:"large",text:"signin_with",width:"300",locale:"en"})})]}),r.jsxs("p",{className:"text-xs text-[var(--color-text-muted)]",children:[g("signInAgreementPrompt")," "," ",r.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:g("footerTerms")})," ",g("and")," "," ",r.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:g("footerPrivacy")}),"."]})]})})};u.displayName="SignInPage";export{u as default};
