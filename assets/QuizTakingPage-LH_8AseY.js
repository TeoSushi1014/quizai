import{j as e}from"./ui-BGuvgkTr.js";import{f as W,u as X,r as n}from"./router-BxjC687J.js";import{u as Y,b as Z,l as B,L as P,C as L,M as _,P as ee,n as U,B as m,i as se,d as te,j as F}from"./index-RewXCStj.js";import{u as ae}from"./useQuizFlow-sC8msB1S.js";import{q as re}from"./quizResultsService-BIvL0NQ5.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-s3HPJSPm.js";const oe=()=>{const{setQuizResult:y,currentUser:x}=Y(),{t}=Z(),{quizId:E}=W(),z=X(),[r,v]=n.useState(null),[k,f]=n.useState(!1),[N,T]=n.useState(!1),O=n.useCallback(()=>{T(!0)},[]),{localActiveQuiz:o,currentQuestion:s,currentQuestionIndex:b,loading:$,timeLeft:h,elapsedTime:j,userAnswers:i,goToNextQuestion:R,goToPreviousQuestion:D,updateUserAnswer:p,formatTime:Q,totalQuestions:l,attemptSettings:S,markQuizCompleted:I}=ae(E,O);n.useEffect(()=>{s&&i[s.id]?v(i[s.id]):v(null)},[s,i]);const G=a=>{v(a)},q=n.useCallback(()=>{if(s&&r)p(s.id,r);else if(s&&!r&&i[s.id]){const a={...i};delete a[s.id],Object.entries(a).forEach(([d,u])=>{p(d,u)})}},[s,r,i,p]),C=n.useCallback(async()=>{if(!o)return;s&&r&&p(s.id,r),await I();let a=0;const d=[];o.questions.forEach(c=>{const g=i[c.id];g?(d.push({questionId:c.id,answer:g}),g===c.correctAnswer&&a++):d.push({questionId:c.id,answer:""})});const u=l>0?a/l*100:0,w={quizId:o.id,userId:x==null?void 0:x.id,score:parseFloat(u.toFixed(2)),answers:d,totalCorrect:a,totalQuestions:l,timeTaken:Math.max(1,j),sourceMode:"take",createdAt:new Date().toISOString()};if(y(w),x)try{await re.saveQuizResult(w)||B.warn("Failed to save quiz result to database","QuizTakingPage")}catch(c){B.error("Error saving quiz result to database","QuizTakingPage",{},c)}f(!1),T(!1),z(`/results/${o.id}`)},[o,s,r,p,y,z,l,S.timeLimit,x,j,i,I]),H=()=>{o&&(q(),R()||f(!0))},J=()=>{q(),D()},A=n.useCallback(()=>f(!1),[]),M=n.useCallback(()=>{C()},[C]);if($||!o)return e.jsx(P,{text:t("quizTakingLoading"),className:"mt-24",size:"xl"});if(!s)return e.jsxs(L,{className:"max-w-3xl mx-auto p-5 sm:p-6 md:p-8 animate-fadeInUp rounded-lg bg-[var(--color-bg-surface-2)]/50 border border-[var(--color-border-default)] shadow-md",children:[e.jsx(P,{text:t("quizTakingLoading")}),e.jsx("p",{className:"text-center text-[var(--color-text-secondary)] mt-4",children:t("quizTakingErrorQuestionNotFound")})]});const K=l>0?(b+1)/l*100:0,V=b===l-1;return e.jsxs(L,{className:"max-w-3xl mx-auto p-5 sm:p-6 md:p-8 animate-fadeInUp rounded-lg bg-[var(--color-bg-surface-2)]/50 border border-[var(--color-border-default)] shadow-md",children:[e.jsxs("div",{className:"mb-6 sm:mb-8",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-3 sm:mb-4 leading-tight tracking-tight line-clamp-2",title:o.title,children:e.jsx(_,{text:o.title,markdownFormatting:!0})}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-[var(--color-text-secondary)] mb-4 sm:mb-5",children:[e.jsx("span",{children:t("quizTakingQuestionProgress",{current:b+1,total:l})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("span",{className:"font-semibold text-[var(--color-text-muted)]",children:["Time: ",Q(j)]}),S.timeLimit!==""&&h!==null&&e.jsx("span",{className:`font-semibold ${h<=60?"text-red-400 animate-pulse":"text-[var(--color-primary-accent)]"}`,children:t("quizTakingTimeLeft",{time:Q(h)})})]})]}),e.jsx(ee,{progress:K,size:"md"})]}),e.jsxs("div",{className:"mt-6 md:mt-8",children:[e.jsx("div",{className:"quiz-question-text text-base sm:text-lg text-[var(--color-text-body)] leading-relaxed mb-4",children:e.jsx(U,{content:s.questionText})}),e.jsx("div",{className:"quiz-options space-y-3",children:s.options.map((a,d)=>{const u=r===a;return e.jsxs("button",{onClick:()=>G(a),className:`w-full flex items-center text-left p-3.5 sm:p-4 rounded-xl border-2 focus:outline-none focus-visible:ring-4 focus-visible:ring-[var(--color-primary-accent)]/50 focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--color-bg-default)] shadow-lg transition-all var(--duration-fast) var(--ease-ios) will-change-transform, border, background-color ${u?"bg-[var(--color-primary-accent)]/50 border-[var(--color-primary-accent)] text-[var(--color-primary-accent-text)] font-semibold scale-[1.01]":"bg-[var(--color-bg-surface-3)]/70 hover:bg-[var(--color-bg-surface-3)]/40 border-[var(--color-border-interactive)] hover:border-[var(--color-primary-accent)] text-[var(--color-text-primary)]"}`,"aria-pressed":u,children:[e.jsx("span",{className:`option-indicator mr-3.5 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors var(--duration-fast) var(--ease-ios) ${u?"border-[var(--color-primary-accent-text)] bg-[var(--color-primary-accent)]":"border-[var(--color-text-muted)] bg-[var(--color-bg-surface-2)] group-hover:border-[var(--color-primary-accent)]"}`}),e.jsx("div",{className:"text-sm sm:text-base flex-grow markdown-content",children:e.jsx(U,{content:a})})]},d)})})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pt-6 sm:pt-8 border-t border-[var(--color-border-default)] mt-6 sm:mt-8",children:[e.jsx(m,{onClick:H,disabled:!r&&!(s&&i[s.id]),variant:"primary",size:"lg",rightIcon:e.jsx(se,{className:"w-5 h-5"}),className:"w-full py-3 rounded-xl",children:t(V?"submit":"nextQuestion")}),e.jsxs("div",{className:"flex justify-between items-center pt-3",children:[e.jsx(m,{onClick:J,disabled:b===0,variant:"outline",size:"md",leftIcon:e.jsx(te,{className:"w-4 h-4"}),className:"py-2.5 px-5 rounded-lg",children:t("previous")}),e.jsx(m,{onClick:()=>f(!0),variant:"outline",size:"md",className:"py-2.5 px-5 rounded-lg",children:t("quizTakingSubmitQuiz")})]})]}),k&&e.jsx(F,{isOpen:k,onClose:A,title:t("quizTakingSubmitQuiz"),size:"md",footerContent:e.jsxs("div",{className:"flex justify-end gap-3.5",children:[e.jsx(m,{variant:"secondary",onClick:A,size:"md",children:t("cancel")}),e.jsx(m,{variant:"primary",onClick:C,size:"md",children:t("submit")})]}),children:e.jsx("p",{className:"text-[var(--color-text-body)] text-base leading-relaxed",children:t("submitConfirmationMessage")})}),N&&e.jsx(F,{isOpen:N,onClose:M,title:t("timesUp"),size:"md",hideCloseButton:!0,footerContent:e.jsx("div",{className:"flex justify-center",children:e.jsx(m,{variant:"primary",onClick:M,size:"md",children:t("timesUpSubmit")})}),children:e.jsx("p",{className:"text-[var(--color-text-body)] text-base leading-relaxed text-center",children:t("timesUpMessage")})})]})};oe.displayName="QuizTakingPage";export{oe as default};
