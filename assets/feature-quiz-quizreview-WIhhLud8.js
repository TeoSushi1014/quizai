import{r as e,j as t}from"./core-react-DcE6uGcR.js";import{a,u as i,z as s,L as r,C as o,N as n,f as l,B as d,A as c,J as u,K as p,n as m,O as x,I as v,t as g,E as h,M as f,G as w,m as y,T as z,D as b,p as j,Q as E,x as N,d as q,R as I}from"./app-components-CFPFxe5x.js";import{l as Q,k as S,n as R,o as T}from"./services-BHj8px4z.js";import{q as A,i as C,g as O}from"./feature-quiz-2SquOiTn.js";import{m as k}from"./ui-framework-CdNWeEQR.js";import{u as D,a as _,d as P}from"./router-Dk7yDelZ.js";import"./katex-core-BbYO2yyT.js";import"./katex-extras-AZS8NW-4.js";import"./service-supabase-wASzC9XA.js";import"./google-services-Bc_loC93.js";/* empty css                        */import"./feature-quiz-home-Ch5jepSG.js";import"./feature-quiz-components-CChsAlA6.js";import"./feature-quiz-dashboard-C8yrEGC7.js";import"./markdown-processors-D3jN8hOQ.js";import"./react-markdown-Cej2CoYR.js";import"./feature-quiz-sharedquiz-Clu9xfzS.js";import"./util-storage-UFVse9kk.js";import"./util-document-Dv5rbOR1.js";import"./util-pdf-CkIVnOzu.js";const U=({isOpen:i,onClose:s,quiz:r})=>{const{t:o}=a(),[n,l]=e.useState("style1"),[c,u]=e.useState(""),[p,m]=e.useState(!1),[x,v]=e.useState(null);e.useEffect(()=>{if(i&&r){v(null);try{let e="";switch(n){case"style1":e=T(r,o);break;case"style2":e=R(r,o);break;case"style4":e=S(r,o);break;default:e=o("azotaExportErrorGenerating")}u(e)}catch(e){Q.error("Error formatting quiz for Azota:","AzotaExportModal",{quizId:r.id,format:n},e),u(o("azotaExportErrorGenerating")),v(e instanceof Error?e.message:String(e))}}},[i,r,n,o]);const g=[{value:"style1",label:o("azotaExportFormatStyle1")},{value:"style2",label:o("azotaExportFormatStyle2")},{value:"style4",label:o("azotaExportFormatStyle4")}];return r?t.jsx(f,{isOpen:i,onClose:s,title:o("azotaExportTitle"),size:"3xl",children:t.jsxs("div",{className:"space-y-6",children:[t.jsx(N,{label:o("azotaExportSelectFormat"),options:g,value:n,onChange:e=>l(e.target.value)}),x&&t.jsxs("div",{role:"alert",className:"p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-xs text-red-300",children:[t.jsxs("p",{children:[t.jsxs("strong",{children:[o("error"),":"]})," ",o("azotaExportErrorGenerating")]}),t.jsx("p",{className:"mt-1 text-red-400/80",children:x})]}),t.jsx(j,{value:c,readOnly:!0,rows:18,className:"text-xs font-mono !bg-slate-700/70 !border-slate-600 p-4 min-h-[360px] shadow-inner","aria-label":o("azotaExportPreviewArea")}),t.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3.5 pt-2",children:[t.jsx(d,{variant:"secondary",onClick:s,size:"md",children:o("close")}),t.jsxs(d,{variant:"outline",onClick:()=>{navigator.clipboard.writeText(c).then(()=>{m(!0),setTimeout(()=>m(!1),2e3)}).catch(e=>{Q.error("Failed to copy Azota text to clipboard","AzotaExportModal",void 0,e),alert(o("azotaExportErrorCopy"))})},leftIcon:t.jsx(q,{className:"w-4 h-4"}),size:"md",className:"w-full sm:w-auto",disabled:!!x,children:[" ",o(p?"azotaExportCopied":"azotaExportCopy")," "]}),t.jsxs(d,{variant:"primary",onClick:()=>{const e=new Blob([c],{type:"text/plain;charset=utf-8"}),t=document.createElement("a");t.href=URL.createObjectURL(e);const a=r.title.replace(/[^a-z0-9_.-]/gi,"_").substring(0,50)||"quiz";t.download=`${a}_Azota_${n}.txt`,document.body.appendChild(t),t.click(),document.body.removeChild(t),Q.info("Azota quiz downloaded","AzotaExportModal",{quizId:r.id,format:n,filename:t.download})},leftIcon:t.jsx(I,{className:"w-4 h-4"}),size:"md",className:"w-full sm:w-auto",disabled:!!x,children:[" ",o("azotaExportDownload")," "]})]})]})}):null};U.displayName="AzotaExportModal";const L=({question:i,index:s,dispatch:r,animationDelayFactor:n})=>{const{t:l}=a(),c=e.useRef(null);y(c,{threshold:.1,freezeOnceVisible:!0});const u=i.options.map((e,t)=>({value:e,label:`${l("reviewOptionLabel",{index:t+1})}: ${e.length>30?e.substring(0,27)+"...":e}`}));0===u.length&&i.correctAnswer&&u.push({value:i.correctAnswer,label:i.correctAnswer});const p=(e,t)=>{r({type:"UPDATE_QUESTION",payload:{index:s,question:{...i,[e]:t}}})};return t.jsx(k.div,{ref:c,className:"question-item-motion-wrapper",children:t.jsxs(o,{useGlassEffect:!0,className:"shadow-xl !rounded-2xl !border-slate-700/50",children:[t.jsxs("div",{className:"flex justify-between items-center mb-5 sm:mb-6",children:[t.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-[var(--color-primary-accent)]",children:l("reviewQuestionLabel",{index:s+1})}),t.jsx(z,{content:l("reviewDeleteQuestionLabel"),placement:"left",children:t.jsx(d,{variant:"danger",size:"sm",onClick:()=>{r({type:"REMOVE_QUESTION_REQUEST",payload:{index:s,questionId:i.id}})},className:"!p-2.5 rounded-lg shadow-md hover:shadow-[var(--color-danger-accent)]/50 bg-transparent","aria-label":l("reviewDeleteQuestionLabel"),children:t.jsx(b,{className:"w-4 h-4 text-[var(--color-danger-accent)]"})})})]}),t.jsxs("div",{className:"space-y-5 sm:space-y-6",children:[t.jsx(j,{label:t.jsx("span",{className:"font-medium text-[var(--color-text-primary)]",children:l("reviewQuestionTextLabel")}),value:i.questionText,onChange:e=>p("questionText",e.target.value),placeholder:l("reviewQuestionTextPlaceholder"),rows:3,className:"min-h-[80px] text-sm"}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--color-text-primary)] mb-2.5",children:l("reviewOptionsLabel")}),t.jsx("div",{className:"space-y-3.5",children:i.options.map((e,a)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(v,{id:`option-input-${i.id}-${a}`,value:e,onChange:e=>((e,t)=>{const a=[...i.options];a[e]=t;let o=i.correctAnswer;i.correctAnswer===i.options[e]?o=t:!a.includes(i.correctAnswer)&&a.length>0?o=a[0]:0===a.length&&(o=""),r({type:"UPDATE_QUESTION",payload:{index:s,question:{...i,options:a,correctAnswer:o}}})})(a,e.target.value),placeholder:l("reviewOptionPlaceholder",{index:a+1}),inputClassName:"text-sm !py-2.5",containerClassName:"flex-grow"}),i.options.length>2&&t.jsx(z,{content:l("reviewRemoveOptionLabel"),placement:"right",children:t.jsx(d,{variant:"ghost",size:"sm",onClick:()=>(e=>{if(i.options.length<=2)return void alert(l("reviewErrorNotEnoughOptions",{id:""}).replace(" for question ID: {id}",""));const t=i.options[e],a=i.options.filter((t,a)=>a!==e);let o=i.correctAnswer;t!==i.correctAnswer||a.includes(t)||(o=a.length>0?a[0]:""),r({type:"UPDATE_QUESTION",payload:{index:s,question:{...i,options:a,correctAnswer:o}}})})(a),className:"!p-2.5 rounded-lg text-[var(--color-danger-accent)] hover:text-[var(--color-danger-accent)] hover:bg-[var(--color-danger-accent)]/10 bg-transparent","aria-label":l("reviewRemoveOptionLabel"),children:t.jsx(b,{className:"w-4 h-4"})})})]},a))}),i.options.length<5&&t.jsx(d,{variant:"outline",size:"sm",onClick:()=>{if(i.options.length>=5)return;const e=l("reviewNewOptionDefault",{index:i.options.length+1}),t=[...i.options,e];r({type:"UPDATE_QUESTION",payload:{index:s,question:{...i,options:t}}})},leftIcon:t.jsx(E,{className:"w-4 h-4",strokeWidth:2}),className:"mt-4 py-2 px-4 rounded-lg border-dashed border-[var(--color-primary-accent)] text-[var(--color-primary-accent)] hover:bg-[var(--color-primary-accent)]/15 hover:border-[var(--color-primary-accent)]",children:l("reviewAddOption")})]}),t.jsx(N,{label:t.jsx("span",{className:"font-medium text-[var(--color-text-primary)]",children:l("reviewCorrectAnswerLabel")}),value:i.correctAnswer,onChange:e=>p("correctAnswer",e.target.value),options:u.length>0?u:[{value:"",label:"Please add options"}],disabled:0===u.length,className:"text-sm"}),t.jsx(j,{label:t.jsx("span",{className:"font-medium text-[var(--color-text-primary)]",children:l("reviewExplanationLabel")}),value:i.explanation,onChange:e=>p("explanation",e.target.value),placeholder:l("reviewExplanationPlaceholder"),rows:3,className:"min-h-[80px] text-sm"})]})]})})};L.displayName="QuestionItem";const M=()=>{const y=D(),z=_(),{t:b,language:j}=a(),{addQuiz:E,updateQuiz:N,quizzes:q,currentUser:I}=i(),{notification:S,showSuccess:R,showError:T,clearNotification:k}=s(),[M,G]=e.useReducer(A,C),{editableQuiz:F,isLoading:$,isSaving:V,error:B,questionToDelete:Z}=M,[W,J]=e.useState(!1),[K,H]=e.useState(null),[X,Y]=e.useState({isOpen:!1,questionIndex:null,questionId:null}),{quizId:ee}=P();e.useEffect(()=>{var e;Q.info("QuizReviewPage: Initializing or location state changed.","QuizReviewPage",{hasLocationState:!!y.state,existingQuizIdFromParams:ee}),G({type:"SET_LOADING",payload:!0});let t=null;y.state&&(t=y.state);const a=ee||(null==(e=null==t?void 0:t.existingQuiz)?void 0:e.id);let i=null;if(a){if(i=(null==t?void 0:t.existingQuiz)||q.find(e=>e.id===a)||null,!i)return Q.error("Quiz not found for editing.","QuizReviewPage",{existingQuizId:a}),G({type:"SET_ERROR",payload:b("reviewErrorQuizNotFound")}),void G({type:"SET_LOADING",payload:!1});Q.info("Loading existing quiz for review/edit.","QuizReviewPage",{quizId:i.id})}else if((null==t?void 0:t.generatedQuizData)&&t.finalConfig){const{generatedQuizData:e,quizTitleSuggestion:a,finalConfig:s}=t,r=(new Date).toISOString();i={id:O(),title:a||e.title||b("untitledQuiz"),questions:e.questions,config:s,sourceContentSnippet:e.sourceContentSnippet,createdAt:r,lastModified:r},Q.info("Initializing review page with newly generated quiz data.","QuizReviewPage",{title:i.title})}i?G({type:"INIT_QUIZ_DATA",payload:{quiz:i,language:j}}):ee||(Q.warn("No quiz data provided to review page.","QuizReviewPage"),G({type:"SET_ERROR",payload:b("reviewErrorNoQuizData")}),G({type:"SET_LOADING",payload:!1}))},[y.state,ee,q,b,j,G]),e.useEffect(()=>{if(K&&F){if(F.questions.find(e=>e.id===K.questionId)){const e=`option-input-${K.questionId}-${K.optionIndex}`,t=document.getElementById(e);null==t||t.focus()}H(null)}},[K,F]),e.useEffect(()=>{Z&&Y({isOpen:!0,questionIndex:Z.index,questionId:Z.questionId})},[Z]);const te=()=>{G({type:"ADD_QUESTION",payload:{language:j}}),Q.info("Added new question to quiz being reviewed.","QuizReviewPage")},ae=e.useCallback(()=>J(!1),[]);if($)return t.jsx(r,{text:b("loading"),className:"mt-24",size:"xl"});if(B&&!F&&!V)return t.jsx(o,{className:"text-[var(--color-danger-accent)] p-12 text-center shadow-xl !border-[var(--color-danger-accent)]/70 !bg-[var(--color-danger-accent)]/10 text-lg font-semibold !rounded-2xl animate-fadeInUp",useGlassEffect:!0,children:B});if(!F)return t.jsx(o,{className:"text-[var(--color-text-muted)] p-12 text-center shadow-lg text-lg font-medium !rounded-2xl animate-fadeInUp",useGlassEffect:!0,children:b("reviewErrorNoQuizData")});const ie=!!ee;return t.jsxs("div",{className:"pb-16",children:[t.jsx(n,{notification:S,onClose:k}),t.jsx("div",{className:"sticky-review-actions bg-[var(--color-bg-surface-2)] shadow-xl py-4 -mx-4 sm:-mx-6 lg:-mx-8 rounded-b-2xl border-b border-[var(--color-border-default)] animate-fadeInUp sticky top-0 z-50",children:t.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:[t.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-[var(--color-text-primary)] leading-tight truncate tracking-tight flex items-center",title:F.title,children:t.jsx(l,{text:b(ie?"reviewEditQuizTitle":"reviewFinalizeQuizTitle"),markdownFormatting:!0})}),t.jsxs("div",{className:"flex flex-wrap justify-center sm:justify-end items-center gap-2.5",children:[!ie&&t.jsxs(d,{variant:"outline",size:"sm",onClick:()=>z("/create"),leftIcon:t.jsx(c,{className:"w-4 h-4"}),children:[" ",b("reviewDiscardRegenerateShort")," "]}),t.jsxs(d,{variant:"secondary",size:"sm",onClick:()=>z("/dashboard"),leftIcon:t.jsx(u,{className:"w-4 h-4"}),children:[" ",b(ie?"cancel":"reviewDiscardToDashboardShort")," "]}),t.jsxs(d,{variant:"outline",size:"sm",onClick:()=>J(!0),leftIcon:t.jsx(p,{className:"w-4 h-4"}),className:"border-[var(--color-primary-accent)] text-[var(--color-primary-accent)] hover:bg-[var(--color-primary-accent)]/15",disabled:!F||0===F.questions.length,children:[" ",b("azotaExportButton")," "]}),t.jsx(d,{variant:"outline",size:"sm",onClick:te,leftIcon:t.jsx(m,{className:"w-4 h-4"}),className:"border-[var(--color-primary-accent)] text-[var(--color-primary-accent)] hover:bg-[var(--color-primary-accent)]/15",children:"Add Question"}),t.jsx(d,{variant:"primary",size:"sm",onClick:async()=>{if(!F||0===F.questions.length)return G({type:"SET_ERROR",payload:b("reviewCannotSaveNoQuestions")}),void Q.warn("Attempted to save quiz with no questions.","QuizReviewPage",{quizId:null==F?void 0:F.id});for(const t of F.questions){if(!t.questionText.trim())return void G({type:"SET_ERROR",payload:b("reviewErrorEmptyQuestionText",{id:t.id.substring(0,8)})});if(t.options.length<2)return void G({type:"SET_ERROR",payload:b("reviewErrorNotEnoughOptions",{id:t.id.substring(0,8)})});if(!t.correctAnswer||!t.options.includes(t.correctAnswer))return void G({type:"SET_ERROR",payload:b("reviewErrorInvalidCorrectAnswer",{id:t.id.substring(0,8)})});if(!t.explanation.trim())return void G({type:"SET_ERROR",payload:b("reviewErrorEmptyExplanation",{id:t.id.substring(0,8)})})}if(G({type:"SET_ERROR",payload:null}),!V){G({type:"SET_SAVING",payload:!0});try{const e=(new Date).toISOString();let t=ee||F.id;t||(t=O());const a={...F,id:t,title:F.title.trim()||b("untitledQuiz"),createdAt:F.createdAt||e,lastModified:e,config:F.config||{numQuestions:F.questions.length,difficulty:"Medium",language:"vi"===j?"Vietnamese":"English",customUserPrompt:"",selectedModel:w}};Q.info("Attempting to save quiz...","QuizReviewPage",{quizId:a.id,title:a.title,questionCount:a.questions.length}),ee?await N(a):await E(a),Q.info("Quiz saved successfully. Navigating to dashboard.","QuizReviewPage",{quizId:a.id}),z("/dashboard")}catch(e){Q.error("Error saving quiz","QuizReviewPage",{quizId:null==F?void 0:F.id},e),G({type:"SET_ERROR",payload:b("reviewErrorSaving")})}finally{G({type:"SET_SAVING",payload:!1})}}},isLoading:V,disabled:V||!F.questions.length,leftIcon:t.jsx(x,{className:"w-4 h-4"}),className:"bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white shadow-lg px-4 font-semibold",children:V?"Saving...":ie?"Save Changes":"Save Quiz"})]})]}),t.jsxs("div",{className:"flex items-center mt-2",children:[t.jsxs("span",{className:"text-sm font-medium text-[var(--color-text-secondary)] mr-2",children:[F.questions.length," ",1===F.questions.length?"Question":"Questions"]}),B&&t.jsx("p",{className:"text-xs text-[var(--color-danger-accent)] ml-2 animate-fadeIn",children:B})]})]})}),t.jsxs("div",{className:"pt-6 sm:pt-8",children:[t.jsxs(o,{useGlassEffect:!0,className:"shadow-xl !rounded-2xl !border-slate-700/50 mb-6 sm:mb-8",children:[t.jsx(v,{label:t.jsx("p",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:b("reviewQuizTitleLabel")}),value:F.title,onChange:e=>{return t=e.target.value,void G({type:"UPDATE_QUIZ_TITLE",payload:t});var t},placeholder:b("step2QuizTitlePlaceholder"),inputClassName:"text-xl py-3.5",containerClassName:"mb-2"}),F.sourceContentSnippet&&t.jsxs("details",{className:"mt-4",children:[t.jsxs("summary",{className:"text-xs text-[var(--color-text-muted)] cursor-pointer hover:text-[var(--color-primary-accent)] flex items-center font-semibold group transition-colors var(--duration-fast) var(--ease-ios)",children:[t.jsx(g,{className:"w-4 h-4 mr-2.5 text-[var(--color-text-secondary)] group-hover:text-[var(--color-primary-accent)] transition-colors var(--duration-fast) var(--ease-ios)",strokeWidth:2}),b("resultsViewSourceSnippet")]}),t.jsx("blockquote",{className:"mt-3 text-xs text-[var(--color-text-muted)]/80 max-h-24 overflow-y-auto p-3 bg-[var(--color-bg-surface-2)] border border-[var(--color-border-default)] rounded-lg shadow-inner italic",children:t.jsx(h,{content:F.sourceContentSnippet})})]})]}),t.jsx("div",{className:"space-y-6 sm:space-y-8",children:F.questions.map((e,a)=>t.jsx(L,{question:e,index:a,dispatch:G,animationDelayFactor:a},e.id))})]}),t.jsx("div",{className:"mt-10 sm:mt-12 text-center pb-20",children:t.jsx(d,{variant:"subtle",onClick:te,leftIcon:t.jsx(m,{className:"w-5 h-5"}),className:"border-2 border-dashed border-[var(--color-primary-accent)] hover:border-[var(--color-primary-accent)]/80 text-[var(--color-primary-accent)] hover:text-[var(--color-primary-accent)] py-3 px-6 rounded-xl shadow-lg hover:shadow-black/20",children:b("reviewAddNewQuestion")})}),F&&W&&t.jsx(U,{isOpen:W,onClose:ae,quiz:F}),X.isOpen&&t.jsx(f,{isOpen:X.isOpen,onClose:()=>Y({isOpen:!1,questionIndex:null,questionId:null}),title:b("confirmDeletionTitle"),size:"md",footerContent:t.jsxs("div",{className:"flex justify-end gap-3.5",children:[t.jsx(d,{variant:"secondary",onClick:()=>Y({isOpen:!1,questionIndex:null,questionId:null}),size:"md",children:b("cancel")}),t.jsx(d,{variant:"danger",onClick:async()=>{if(!F||null===X.questionIndex||null===X.questionId)return;const e=X.questionIndex;Y({isOpen:!1,questionIndex:null,questionId:null});const t={...F,questions:F.questions.filter((t,a)=>a!==e),lastModified:(new Date).toISOString()};G({type:"REMOVE_QUESTION_CONFIRMED",payload:{index:e}});try{await N(t),Q.info("Question deleted and quiz updated","QuizReviewPage",{quizId:t.id,questionId:X.questionId,remainingQuestions:t.questions.length}),R(b("questionDeletedSuccessfully"),3e3)}catch(a){Q.error("Error saving quiz after question deletion","QuizReviewPage",{quizId:t.id,questionId:X.questionId},a),T(b("reviewErrorSaving"),5e3),G({type:"INIT_QUIZ_DATA",payload:{quiz:F,language:j}})}},size:"md",children:b("confirmDeleteButton")})]}),children:t.jsx("p",{className:"text-[var(--color-text-primary)] text-base leading-relaxed",children:b("reviewDeleteQuestionConfirmationMessage",{questionIndex:(X.questionIndex??0)+1})})})]})};M.displayName="QuizReviewPage";export{M as default};
