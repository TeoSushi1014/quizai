import{r as e}from"./core-react-DcE6uGcR.js";import{u as t}from"./app-components-CFPFxe5x.js";import{d as r}from"./services-BHj8px4z.js";import{a as n,u,d as s}from"./router-Dk7yDelZ.js";function i(e){if(!e)return[];const t=[...e];for(let r=t.length-1;r>0;r--){const e=Math.floor(Math.random()*(r+1));[t[r],t[e]]=[t[e],t[r]]}return t}const l={shuffleQuestions:!1,shuffleAnswers:!1,timeLimit:""},a=(a,o)=>{var c;const{quizzes:d,activeQuiz:f,setActiveQuiz:v,currentUser:m}=t(),h=n(),p=u(),{quizId:I}=s(),S=a||I,[g,w]=e.useState(null),[Q,k]=e.useState(l),[z,b]=e.useState([]),[y,C]=e.useState(0),[A,M]=e.useState({}),[q,x]=e.useState(!0),[N,T]=e.useState(null),[E,L]=e.useState(0),[j,P]=e.useState(null),[R,J]=e.useState("take"),[O,D]=e.useState(!1),U=e.useRef(null),$=e.useRef(null),B=e.useRef(null),F=e.useRef(null);e.useEffect(()=>{const e=p.pathname;e.includes("/practice/")?J("practice"):e.includes("/take/")&&J("take")},[p.pathname]);const G=null==(c=p.state)?void 0:c.attemptSettings,H=e.useMemo(()=>G,[JSON.stringify(G)]),K=e.useCallback(async()=>{if(!(null==m?void 0:m.id)||!S)return!1;try{const e=await r.getQuizProgress(m.id,S,R);return!!e&&(P(e.id||null),C(e.currentQuestionIndex),M(e.answers||{}),L(e.elapsedTime||0),!0)}catch(e){return!1}},[null==m?void 0:m.id,S,R]),V=e.useCallback(async(e=!1)=>{if((null==m?void 0:m.id)&&S&&g&&!O)try{D(!0);const t={id:j||void 0,quizId:S,userId:m.id,currentQuestionIndex:y,answers:A,completed:e,mode:R,elapsedTime:E},n=await r.saveQuizProgress(t);n&&!j&&P(n)}catch(t){return}finally{D(!1)}},[null==m?void 0:m.id,S,g,j,y,A,R,E,O]);e.useEffect(()=>{let e=!0;return(async()=>{if(!S)return void(e&&h("/dashboard"));const t=H||((null==g?void 0:g.id)===S?Q:l);e&&JSON.stringify(t)!==JSON.stringify(Q)&&k(t);let r=f&&f.id===S?f:d.find(e=>e.id===S);if(r){if(e){w(r),f&&f.id===r.id||v(r);let e=r.questions;t.shuffleQuestions&&(e=i([...r.questions])),b(e),(null==m?void 0:m.id)?await K()||(C(0),M({})):C(0),""!==t.timeLimit&&Number(t.timeLimit)>0?T(60*Number(t.timeLimit)):T(null)}}else e&&h("/dashboard");e&&x(!1)})(),()=>{e=!1,U.current&&clearInterval(U.current),$.current&&clearInterval($.current),F.current&&clearInterval(F.current)}},[S,d,f,h,v,H,null==g?void 0:g.id,Q,K,null==m?void 0:m.id]),e.useEffect(()=>{if(g&&!q)return B.current||(B.current=Date.now(),0===E&&L(0)),$.current=window.setInterval(()=>{const e=Date.now(),t=Math.floor((e-B.current)/1e3);L(t)},1e3),(null==m?void 0:m.id)&&(F.current=window.setInterval(()=>{V(!1)},3e4)),()=>{$.current&&clearInterval($.current),F.current&&clearInterval(F.current)}},[g,q,E,null==m?void 0:m.id,V]),e.useEffect(()=>()=>{B.current=null,U.current&&clearInterval(U.current),$.current&&clearInterval($.current),F.current&&clearInterval(F.current)},[]),e.useEffect(()=>{if(null!==N)return N<=0?(U.current&&clearInterval(U.current),void(g&&o&&o())):(U.current=window.setInterval(()=>{T(e=>e?e-1:0)},1e3),()=>{U.current&&clearInterval(U.current)});U.current&&clearInterval(U.current)},[N,g,o]);const W=e.useMemo(()=>{if(!z||0===z.length||y>=z.length)return;const e=z[y];return e&&Q.shuffleAnswers?{...e,options:i([...e.options])}:e},[z,y,Q.shuffleAnswers]),X=e.useCallback(()=>y<z.length-1&&(C(e=>e+1),(null==m?void 0:m.id)&&V(!1),!0),[y,z.length,null==m?void 0:m.id,V]),Y=e.useCallback(()=>y>0&&(C(e=>e-1),!0),[y]),Z=e.useCallback((e,t)=>{M(r=>({...r,[e]:t}))},[]),_=e.useCallback(async()=>{(null==m?void 0:m.id)&&S&&await V(!0)},[null==m?void 0:m.id,S,V]);return{localActiveQuiz:g,shuffledQuestions:z,currentQuestion:W,currentQuestionIndex:y,userAnswers:A,loading:q,timeLeft:N,elapsedTime:E,attemptSettings:Q,goToNextQuestion:X,goToPreviousQuestion:Y,updateUserAnswer:Z,formatTime:e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},totalQuestions:z.length,setShuffledQuestions:b,setCurrentQuestionIndex:C,saveProgress:V,markQuizCompleted:_,quizMode:R}};export{a as u};
