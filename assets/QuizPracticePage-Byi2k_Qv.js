import{j as e}from"./ui-BGuvgkTr.js";import{f as se,u as ie,r as o}from"./router-BxjC687J.js";import{b as U,P as re,n as B,B as N,u as ne,l as q,L as S,C as le,d as ae,i as ce,j as oe}from"./index-RewXCStj.js";import{u as de}from"./useQuizFlow-sC8msB1S.js";import{q as ue}from"./quizResultsService-BIvL0NQ5.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-s3HPJSPm.js";const me=({question:r,options:y,currentIndex:b,totalQuestions:P,selectedOption:u,onSelectOption:n,onCheckAnswer:O,onSkipQuestion:l,isSubmitting:j,isAnswerChecked:g=!1,isAnswerCorrect:k=null,correctAnswer:f=""})=>{const{t:p}=U(),L=P>0?(b+1)/P*100:0;return e.jsxs("div",{className:"quiz-question-container",children:[e.jsxs("div",{className:"quiz-progress",children:[e.jsx("div",{className:"flex justify-between items-center mb-1.5",children:e.jsx("span",{className:"text-sm font-medium text-[var(--color-text-primary)]",children:p("quizTakingQuestionProgress",{current:b+1,total:P})})}),e.jsx(re,{progress:L,size:"md",className:"mb-5"})]}),e.jsx("div",{className:"question-content mb-4",children:e.jsx(B,{content:r})}),e.jsx("div",{className:"question-options space-y-2.5",children:y.map((z,d)=>{const h=u===z,m=g&&z===f;let C="flex w-full p-3.5 rounded-lg border transition-all duration-300 ease-in-out";return h?g?k?C+=" border-green-500 bg-green-500/10":C+=" border-red-500 bg-red-500/10":C+=" border-[var(--color-primary-accent)] bg-[var(--color-primary-accent)]/10":g&&z===f?C+=" border-blue-500 bg-blue-500/10":C+=" border-[var(--color-border-default)] bg-[var(--color-bg-surface-2)]/50 hover:bg-[var(--color-bg-surface-2)]",e.jsxs("button",{className:C,onClick:()=>n(z),disabled:g||j,"aria-checked":h,role:"radio","aria-disabled":g||j,children:[e.jsx("div",{className:"option-index mr-3 min-w-[1.5rem] h-6 flex items-center justify-center rounded-full text-xs font-bold",children:String.fromCharCode(65+d)}),e.jsx("div",{className:"option-content flex-grow text-sm sm:text-base flex items-center",children:e.jsx(B,{content:z,compact:!0})}),g&&e.jsx("span",{className:"ml-2",children:m?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-500",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}):h&&!k?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-500",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}):null})]},d)})}),e.jsx("div",{className:"quiz-actions flex gap-3 mt-6",children:g?e.jsx(N,{variant:"primary",onClick:l,className:"w-full",children:p("nextQuestion")}):e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"primary",onClick:O,disabled:!u||j,className:"flex-1",isLoading:j,children:p("checkAnswer")}),e.jsx(N,{variant:"outline",onClick:l,disabled:j,className:"flex-grow-0 px-4",children:p("skipQuestion")})]})})]})},xe=({explanation:r,className:y=""})=>{const{t:b}=U();return e.jsxs("div",{className:`animate-fadeInUp mt-5 p-5 rounded-lg bg-[var(--color-bg-surface-2)]/50 border border-[var(--color-border-default)] shadow-md ${y}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-[var(--color-primary-accent)]",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsx("span",{className:"font-semibold text-[var(--color-primary-accent)] text-base",children:b("resultsExplanationTitle")})]}),e.jsx("div",{className:"explanation-content",children:e.jsx("div",{className:"pl-1.5 border-l-2 border-[var(--color-primary-accent)]/20",children:e.jsx("div",{className:"explanation-text text-sm leading-relaxed text-[var(--color-text-body)] markdown-content",children:e.jsx(B,{content:r})})})})]})},fe=()=>{const{t:r}=U(),{quizId:y}=se(),b=ie(),{setQuizResult:P,currentUser:u}=ne(),[n,O]=o.useState(null),[l,j]=o.useState(!1),[g,k]=o.useState(null),[f,p]=o.useState([]),[L,z]=o.useState(!1),[d,h]=o.useState(!1),m=o.useRef(!1),C=o.useCallback(()=>{m.current||z(!0)},[]),{localActiveQuiz:a,currentQuestion:i,currentQuestionIndex:Q,loading:G,timeLeft:A,elapsedTime:T,goToNextQuestion:R,goToPreviousQuestion:D,formatTime:$,totalQuestions:E,shuffledQuestions:M,attemptSettings:V,markQuizCompleted:H,updateUserAnswer:F,userAnswers:J}=de(y,C);o.useEffect(()=>{if(M.length>0&&f.length===0){const s=M.map(t=>{const c=J[t.id],v=c?c===t.correctAnswer:null;return{questionId:t.id,selectedOption:c||null,isCorrect:c?v:null,firstTryCorrect:c?v:null,attempts:c?1:0}});p(s)}},[M,f.length,J]),o.useEffect(()=>{if(m.current)return;let s=null,t=!1,c=null;if(i&&f.length>0){const v=f.find(I=>I.questionId===i.id);v&&(s=v.selectedOption,v.isCorrect!==null&&(t=!0,c=v.isCorrect))}O(s),j(t),k(c),h(!1)},[Q,i,f]),o.useEffect(()=>{u!=null&&u.id&&f.forEach(s=>{s.selectedOption&&s.isCorrect!==null&&F(s.questionId,s.selectedOption)})},[f,F,u==null?void 0:u.id]);const w=o.useCallback(async()=>{if(m.current||!a)return;m.current=!0,h(!0),q.info("Starting practice finish process","QuizPracticePage",{quizId:a.id,currentTime:T});let s=[...f];i&&n&&!l&&(s=s.map(x=>x.questionId===i.id?{...x,selectedOption:n,isCorrect:null,attempts:x.attempts||0}:x)),await H();const t=s.filter(x=>x.isCorrect===!0).length,c=s.map(x=>({questionId:x.questionId,answer:x.selectedOption||""})),v=a.questions.length>0?t/a.questions.length*100:0,I={quizId:a.id,score:parseFloat(v.toFixed(2)),answers:c,totalCorrect:t,totalQuestions:a.questions.length,timeTaken:Math.max(1,T),sourceMode:"practice",createdAt:new Date().toISOString()};if(q.info("Submitting practice result","QuizPracticePage",{quizId:a.id,elapsedTime:T,timeTaken:I.timeTaken}),P(I),u)try{const x=await ue.saveQuizResult(I);x?q.info("Practice result saved to database successfully","QuizPracticePage",{resultId:x}):q.info("Practice result not saved to database (user not authenticated)","QuizPracticePage")}catch(x){q.error("Error saving practice result","QuizPracticePage",{},x)}else q.info("No user logged in, practice result saved locally only","QuizPracticePage");b(`/results/${a.id}`)},[a,f,i,n,l,P,V.timeLimit,A,b,u,T,H]),X=s=>{l||m.current||d||O(s)},Y=()=>{if(!n||!i||m.current||d)return;h(!0);const s=n===i.correctAnswer;j(!0),k(s),p(t=>t.map(c=>c.questionId===i.id?{...c,selectedOption:n,isCorrect:s,attempts:(c.attempts||0)+1,...(c.attempts||0)===0&&{firstTryCorrect:s}}:c)),u!=null&&u.id&&F(i.id,n)},Z=o.useCallback(()=>{!a||!i||m.current||d||(h(!0),n&&!l?p(s=>s.map(t=>t.questionId===i.id&&(t.selectedOption!==n||t.isCorrect===null)?{...t,selectedOption:n,isCorrect:t.isCorrect,attempts:t.attempts||0}:t)):!n&&!l&&p(s=>s.map(t=>t.questionId===i.id&&t.selectedOption!==null&&t.isCorrect===null?{...t,selectedOption:null}:t)),R()||w())},[a,i,R,w,n,l,d]),_=o.useCallback(()=>{!a||!i||m.current||d||(h(!0),R()||w())},[a,i,R,w,d]),ee=o.useCallback(()=>{!i||m.current||d||(h(!0),n&&!l?p(s=>s.map(t=>t.questionId===i.id&&(t.selectedOption!==n||t.isCorrect===null)?{...t,selectedOption:n,isCorrect:t.isCorrect,attempts:t.attempts||0}:t)):!n&&!l&&p(s=>s.map(t=>t.questionId===i.id&&t.selectedOption!==null&&t.isCorrect===null?{...t,selectedOption:null}:t)),D())},[D,n,l,i,d]),K=o.useCallback(()=>{w()},[w]),te=()=>i?e.jsxs("div",{className:"space-y-4",children:[e.jsx(me,{question:i.questionText,options:i.options,currentIndex:Q,totalQuestions:E,selectedOption:n,onSelectOption:X,onCheckAnswer:Y,onSkipQuestion:_,isSubmitting:d,isAnswerChecked:l,isAnswerCorrect:g,correctAnswer:i.correctAnswer}),l&&e.jsx(xe,{explanation:i.explanation||r("resultsNoExplanation")})]}):null;if(d&&m.current)return e.jsx("div",{className:"flex flex-col items-center justify-center p-8 min-h-[400px]",children:e.jsx(S,{text:r("quizPracticeEnding")||"Processing...",size:"lg"})});if(G||!a)return e.jsx(S,{text:r("quizTakingLoading"),className:"mt-24",size:"xl"});if(!i)return a&&E>0&&Q>=E?(m.current||w(),e.jsx("div",{className:"flex flex-col items-center justify-center p-8 min-h-[400px]",children:e.jsx(S,{text:r("quizPracticeEnding")||"Completing practice...",size:"lg"})})):G?e.jsx(S,{text:r("quizTakingLoading"),className:"mt-24",size:"xl"}):e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 min-h-[400px]",children:[e.jsx(S,{text:r("error")+" - "+(r("quizTakingLoading")||"Processing..."),size:"lg"}),e.jsx(N,{onClick:()=>b("/dashboard"),className:"mt-4",children:r("resultsGoToDashboard")})]});const W=Q===E-1;return e.jsxs(le,{className:"max-w-2xl mx-auto shadow-2xl !rounded-2xl animate-page-slide-fade-in p-5 sm:p-6",useGlassEffect:!0,children:[e.jsxs("div",{className:"mb-6 sm:mb-8",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-[var(--color-text-primary)] mb-3 leading-tight tracking-tight line-clamp-2",title:a.title,children:r("quizPracticeTitle",{quizTitle:a.title})}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-[var(--color-text-secondary)] mb-2",children:[e.jsxs("span",{className:"font-semibold text-[var(--color-text-muted)]",children:["Time: ",$(T)]}),V.timeLimit!==""&&A!==null&&e.jsx("span",{className:`font-semibold ${A<=60?"text-red-400 animate-pulse":"text-[var(--color-primary-accent)]"}`,children:r("quizTakingTimeLeft",{time:$(A)})})]})]}),te(),e.jsxs("div",{className:"quiz-navigation-actions mt-6 pt-6 border-t border-[var(--color-border-default)] flex flex-col sm:flex-row sm:justify-between gap-3",children:[e.jsx(N,{variant:"secondary",onClick:ee,disabled:d||Q===0,size:"md",leftIcon:e.jsx(ae,{className:"w-4 h-4"}),className:"w-full sm:w-auto",children:r("previous")}),e.jsx(N,{variant:W&&l?"primary":"secondary",onClick:l?Z:w,disabled:d,size:"md",rightIcon:e.jsx(ce,{className:"w-4 h-4"}),className:"w-full sm:w-auto",children:r(l?W?"finishPractice":"nextQuestion":"finishPractice")})]}),L&&e.jsx(oe,{isOpen:L&&!m.current,onClose:K,title:r("timesUp"),size:"md",hideCloseButton:!0,footerContent:e.jsx("div",{className:"flex justify-center",children:e.jsx(N,{variant:"primary",onClick:K,size:"md",children:r("timesUpSubmit")})}),children:e.jsx("p",{className:"text-[var(--color-text-body)] text-base leading-relaxed text-center",children:r("timesUpMessage")})})]})};fe.displayName="QuizPracticePage";export{fe as default};
