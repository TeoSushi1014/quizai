import{j as o}from"./ui-BGuvgkTr.js";import{u as S,b,R as w}from"./router-BxjC687J.js";import{u as L,c as j,l as r,J as k,C,K as N,B as _}from"./index-mbt189un.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const E={},G=()=>{const{login:h,currentUser:x}=L(),{t:g}=j(),u=S(),m=b(),I=void 0;w.useEffect(()=>{var e,c;if(x){const l=((c=(e=m.state)==null?void 0:e.from)==null?void 0:c.pathname)||"/dashboard";r.info("User already signed in, redirecting.","SignInPage",{from:l}),u(l,{replace:!0})}},[x,u,m.state]);const n=e=>{r.error("Google Login Failed.","SignInPage",{errorDetails:e})},v=async e=>{var c,l;if(r.info("Google Credential Login Succeeded (ID token obtained).","SignInPage",{hasCredential:!!e.credential}),e.credential)try{const d=e.credential.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),p=decodeURIComponent(atob(d).split("").map(function(s){return"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)}).join("")),i=JSON.parse(p);r.info("ID token decoded successfully","SignInPage",{userId:i.sub,email:i.email});const a={id:i.sub,name:i.name,email:i.email,imageUrl:i.picture,accessToken:e.credential,idToken:e.credential};r.info("User profile created from ID token. Calling login context function.","SignInPage",{userId:a.id,hasIdToken:!0});try{const s=await h(a);if(s){r.info("Login completed successfully, redirecting...","SignInPage",{userId:s.id});const P=((l=(c=m.state)==null?void 0:c.from)==null?void 0:l.pathname)||"/dashboard";u(P,{replace:!0})}else r.error("Login returned null result","SignInPage"),n(new Error("Login failed - no user returned"))}catch(s){r.error("Login process failed","SignInPage",void 0,s),n(s)}}catch(t){r.error("Error during credential processing or login","SignInPage",void 0,t),n(t)}else r.error("Credential response received but no credential token","SignInPage",{credentialResponse:e}),n(e)},f=k({onSuccess:async e=>{var c,l;if(r.info("Google Login Succeeded (token obtained).","SignInPage",{hasAccessToken:!!e.access_token}),e.access_token)try{const t=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok){const a=await t.json().catch(()=>({message:"Failed to parse error response from userinfo endpoint"}));r.error("Failed to fetch user info from Google.","SignInPage",{status:t.status,errorData:a}),n(a);return}const d=await t.json(),p=d.picture?d.picture.replace(/=s\d+-c$/,"=s256-c"):d.picture,i={id:d.sub,name:d.name,email:d.email,imageUrl:p,accessToken:e.access_token};r.info("User info fetched successfully. Calling login context function.","SignInPage",{userId:i.id});try{const a=await h(i,e);if(a){r.info("Login completed successfully, redirecting...","SignInPage",{userId:a.id});const s=((l=(c=m.state)==null?void 0:c.from)==null?void 0:l.pathname)||"/dashboard";u(s,{replace:!0})}else r.error("Login returned null result","SignInPage"),n(new Error("Login failed - no user returned"))}catch(a){r.error("Login process failed","SignInPage",void 0,a),n(a)}}catch(t){r.error("Error during token validation, fetching user info, or login process.","SignInPage",void 0,t),n(t)}else r.error("Login success callback, but no access_token in tokenResponse.","SignInPage",{tokenResponse:e}),n(e)},onError:n,scope:"email profile https://www.googleapis.com/auth/drive.file"}),y=()=>{if(r.info("Custom Google Login button clicked.","SignInPage"),!I){r.warn("VITE_RECAPTCHA_SITE_KEY is not configured. Proceeding with login directly.","SignInPage"),f();return}if(typeof grecaptcha>"u"||typeof grecaptcha.enterprise>"u"||typeof grecaptcha.enterprise.ready!="function"){r.warn("reCAPTCHA enterprise.js not loaded or not ready. Proceeding with login directly.","SignInPage"),f();return}grecaptcha.enterprise.ready(async()=>{try{const e=await grecaptcha.enterprise.execute(I,{action:"LOGIN"});r.info("reCAPTCHA token obtained for LOGIN action.","SignInPage",{tokenPreview:e.slice(0,10)+"..."}),f()}catch(e){r.error("Lỗi khi thực thi reCAPTCHA (token generation):","SignInPage",void 0,e),f()}})};return o.jsx("div",{className:"flex flex-col items-center justify-center min-h-[calc(100vh-250px)] py-10 sm:py-16",children:o.jsxs(C,{className:"max-w-md w-full text-center shadow-2xl p-8 sm:p-10 md:p-12 !rounded-2xl",useGlassEffect:!0,children:[o.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-4 mt-8 sm:mt-10",children:g("signInTitle")}),o.jsx("p",{className:"text-[var(--color-text-secondary)] mb-10 text-sm",children:g("signInSubtitle")}),o.jsxs("div",{className:"flex flex-col items-center space-y-4 mb-8",children:[o.jsx("div",{className:"w-full max-w-xs sm:w-[280px]",children:o.jsx(N,{onSuccess:v,onError:()=>n("Google Login failed"),useOneTap:!1,shape:"rectangular",theme:"outline",size:"large",text:"signin_with",width:"280",locale:"en"})}),o.jsxs("div",{className:"w-full max-w-xs sm:w-[280px]",children:[o.jsx("div",{className:"text-xs text-[var(--color-text-muted)] text-center mb-2",children:"Or use fallback authentication:"}),o.jsx(_,{onClick:y,variant:"subtle",size:"sm",leftIcon:o.jsx("img",{src:"https://img.icons8.com/color/48/google-logo.png",alt:"Google",className:"w-4 h-4"}),className:"w-full !justify-start !text-[var(--color-text-secondary)] hover:!bg-[var(--color-bg-surface-2)] !border-[var(--color-border-subtle)] hover:!border-[var(--color-border-interactive)] !px-3 !py-2 !rounded-md shadow-sm",children:o.jsx("span",{className:"ml-2 text-xs font-medium",children:"Google (Fallback)"})})]})]}),o.jsxs("p",{className:"text-xs text-[var(--color-text-muted)]",children:[g("signInAgreementPrompt")," "," ",o.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:g("footerTerms")})," ",g("and")," "," ",o.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:g("footerPrivacy")}),"."]})]})})};G.displayName="SignInPage";export{G as default};
