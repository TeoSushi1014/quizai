import{j as o}from"./ui-BGuvgkTr.js";import{u as N,b as P,R as m}from"./router-BxjC687J.js";import{u as k,c as G,l as n,J as j,C as E,K as A,B as C}from"./index-D3S7idsR.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const O={},U=()=>{const{login:w,currentUser:b}=k(),{t:d}=G(),h=N(),f=P(),I=void 0;m.useEffect(()=>{var e,a;if(b){const l=((a=(e=f.state)==null?void 0:e.from)==null?void 0:a.pathname)||"/dashboard";n.info("User already signed in, redirecting.","SignInPage",{from:l}),h(l,{replace:!0})}},[b,h,f.state]),m.useEffect(()=>{console.log("üîç SignInPage loaded, GoogleLogin component should be available"),console.warn("üö® IMPORTANT: Use the GREEN BORDERED button (top) for quiz sharing to work!"),console.warn("üö® Do NOT use the small grey button (bottom) - it won't work for sharing!");const e=!!window.google,a=!!document.querySelector('script[src*="accounts.google.com"]');n.info("SignInPage loaded - checking Google OAuth setup","SignInPage",{hasGoogleOAuth:e,hasGoogleScript:a,currentDomain:window.location.hostname,currentURL:window.location.href}),setTimeout(()=>{var l,r,i,u,c;console.log("üß™ Testing Google OAuth availability:",{googleObject:!!window.google,googleAccounts:!!((l=window.google)!=null&&l.accounts),googleId:!!((i=(r=window.google)==null?void 0:r.accounts)!=null&&i.id),domain:window.location.hostname}),(c=(u=window.google)==null?void 0:u.accounts)!=null&&c.id||(console.error("üî¥ Google OAuth not properly loaded! GoogleLogin component may not work."),console.error("üî¥ This could be why you're not seeing the ID token authentication working."))},2e3)},[]);const[_,y]=m.useState(!1),[R,S]=m.useState(!1),s=e=>{n.error("Google Login Failed.","SignInPage",{errorDetails:e})};m.useEffect(()=>{const e=setTimeout(()=>{document.querySelector('[data-testid="google-login"]')||document.querySelector('iframe[src*="accounts.google.com"]')||document.querySelector('[role="button"][aria-label*="Google"]')?(y(!0),console.log("‚úÖ GoogleLogin component is working!")):(S(!0),console.warn("‚ö†Ô∏è GoogleLogin component not detected - showing fallback instructions"),console.warn("üîß This might be due to Google OAuth client domain configuration"),console.warn("üîß The current domain is:",window.location.hostname),console.warn("üîß Make sure the Google OAuth client is configured for this domain"))},3e3);return()=>clearTimeout(e)},[]),m.useEffect(()=>{const e=setTimeout(()=>{console.log("üìã AUTHENTICATION TROUBLESHOOTING:"),console.log("1. Look for the GREEN bordered button with 'Sign in with Google'"),console.log("2. If you see a yellow warning box, READ IT CAREFULLY"),console.log("3. DO NOT click the small red/grey 'Google (Fallback)' button"),console.log("4. The green button provides JWT ID tokens needed for Supabase"),console.log("5. If green button doesn't work, there may be a domain configuration issue")},5e3);return()=>clearTimeout(e)},[]);const v=async e=>{var a,l,r;if(n.info("üéâ GoogleLogin SUCCESS - ID token received!","SignInPage",{hasCredential:!!e.credential,credentialLength:((a=e.credential)==null?void 0:a.length)||0}),e.credential)try{const u=e.credential.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),c=decodeURIComponent(atob(u).split("").map(function(g){return"%"+("00"+g.charCodeAt(0).toString(16)).slice(-2)}).join("")),t=JSON.parse(c);n.info("ID token decoded successfully","SignInPage",{userId:t.sub,email:t.email});const x={id:t.sub,name:t.name,email:t.email,imageUrl:t.picture,idToken:e.credential};n.info("User profile created from ID token. Calling login context function.","SignInPage",{userId:x.id,hasIdToken:!0});try{const g=await w(x);if(g){n.info("Login completed successfully, redirecting...","SignInPage",{userId:g.id});const T=((r=(l=f.state)==null?void 0:l.from)==null?void 0:r.pathname)||"/dashboard";h(T,{replace:!0})}else n.error("Login returned null result","SignInPage"),s(new Error("Login failed - no user returned"))}catch(g){n.error("Login process failed","SignInPage",void 0,g),s(g)}}catch(i){n.error("Error during credential processing or login","SignInPage",void 0,i),s(i)}else n.error("Credential response received but no credential token","SignInPage",{credentialResponse:e}),s(e)},p=j({onSuccess:async e=>{var a,l;if(n.info("Google Login Succeeded (token obtained).","SignInPage",{hasAccessToken:!!e.access_token}),e.access_token)try{const r=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!r.ok){const t=await r.json().catch(()=>({message:"Failed to parse error response from userinfo endpoint"}));n.error("Failed to fetch user info from Google.","SignInPage",{status:r.status,errorData:t}),s(t);return}const i=await r.json(),u=i.picture?i.picture.replace(/=s\d+-c$/,"=s256-c"):i.picture,c={id:i.sub,name:i.name,email:i.email,imageUrl:u,accessToken:e.access_token};n.info("User info fetched successfully. Calling login context function.","SignInPage",{userId:c.id});try{const t=await w(c,e);if(t){n.info("Login completed successfully, redirecting...","SignInPage",{userId:t.id});const x=((l=(a=f.state)==null?void 0:a.from)==null?void 0:l.pathname)||"/dashboard";h(x,{replace:!0})}else n.error("Login returned null result","SignInPage"),s(new Error("Login failed - no user returned"))}catch(t){n.error("Login process failed","SignInPage",void 0,t),s(t)}}catch(r){n.error("Error during token validation, fetching user info, or login process.","SignInPage",void 0,r),s(r)}else n.error("Login success callback, but no access_token in tokenResponse.","SignInPage",{tokenResponse:e}),s(e)},onError:s,scope:"email profile https://www.googleapis.com/auth/drive.file"}),L=()=>{if(n.info("‚ö†Ô∏è  FALLBACK Google Login button clicked - this will use access token only!","SignInPage"),console.warn("üî∏ User clicked FALLBACK authentication - quiz sharing will NOT work!"),!I){n.warn("VITE_RECAPTCHA_SITE_KEY is not configured. Proceeding with login directly.","SignInPage"),p();return}if(typeof grecaptcha>"u"||typeof grecaptcha.enterprise>"u"||typeof grecaptcha.enterprise.ready!="function"){n.warn("reCAPTCHA enterprise.js not loaded or not ready. Proceeding with login directly.","SignInPage"),p();return}grecaptcha.enterprise.ready(async()=>{try{const e=await grecaptcha.enterprise.execute(I,{action:"LOGIN"});n.info("reCAPTCHA token obtained for LOGIN action.","SignInPage",{tokenPreview:e.slice(0,10)+"..."}),p()}catch(e){n.error("L·ªói khi th·ª±c thi reCAPTCHA (token generation):","SignInPage",void 0,e),p()}})};return o.jsx("div",{className:"flex flex-col items-center justify-center min-h-[calc(100vh-250px)] py-10 sm:py-16",children:o.jsxs(E,{className:"max-w-md w-full text-center shadow-2xl p-8 sm:p-10 md:p-12 !rounded-2xl",useGlassEffect:!0,children:[o.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-4 mt-8 sm:mt-10",children:d("signInTitle")}),o.jsx("p",{className:"text-[var(--color-text-secondary)] mb-10 text-sm",children:d("signInSubtitle")}),o.jsxs("div",{className:"flex flex-col items-center space-y-6 mb-8",children:[o.jsxs("div",{className:"w-full max-w-xs sm:w-[280px] bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4 text-center",children:[o.jsx("div",{className:"text-lg font-bold text-yellow-800 mb-2",children:"üö® IMPORTANT"}),o.jsxs("div",{className:"text-sm text-yellow-700",children:["To enable ",o.jsx("strong",{children:"quiz sharing"}),", you MUST use the ",o.jsx("strong",{children:"GREEN button"})," below, NOT the red one!"]})]}),o.jsxs("div",{className:"w-full max-w-xs sm:w-[280px]",children:[o.jsx("div",{className:"text-sm font-medium text-[var(--color-primary-accent)] text-center mb-2",children:"‚ú® Recommended: Full Features"}),o.jsx("div",{className:"border-4 border-green-500 rounded p-3 bg-green-50 shadow-lg",children:o.jsx(A,{onSuccess:v,onError:()=>{n.error("GoogleLogin component failed","SignInPage"),console.error("üî¥ GoogleLogin component error occurred!"),s("Google Login component failed")},useOneTap:!1,shape:"rectangular",theme:"outline",size:"large",text:"signin_with",width:"260",locale:"en"})}),o.jsx("div",{className:"text-sm text-center mt-2 text-green-700 font-bold animate-pulse",children:"üëÜ CLICK THIS FOR QUIZ SHARING üëÜ"})]}),o.jsxs("div",{className:"w-full max-w-xs sm:w-[280px]",children:[o.jsx("div",{className:"text-xs text-[var(--color-text-muted)] text-center mb-2",children:"‚ö†Ô∏è Limited Features (Quiz sharing won't work)"}),o.jsx("div",{className:"border-2 border-red-500 rounded p-2 bg-red-50 opacity-60",children:o.jsx(C,{onClick:L,variant:"subtle",size:"sm",leftIcon:o.jsx("img",{src:"https://img.icons8.com/color/48/google-logo.png",alt:"Google",className:"w-4 h-4"}),className:"w-full !justify-start !text-[var(--color-text-secondary)] hover:!bg-[var(--color-bg-surface-2)] !border-[var(--color-border-subtle)] hover:!border-[var(--color-border-interactive)] !px-3 !py-2 !rounded-md shadow-sm",children:o.jsx("span",{className:"ml-2 text-xs font-medium",children:"Google (Fallback)"})})}),o.jsx("div",{className:"text-xs text-center mt-1 text-red-600 font-bold",children:"‚ùå DON'T USE THIS - NO SHARING!"})]})]}),o.jsxs("p",{className:"text-xs text-[var(--color-text-muted)]",children:[d("signInAgreementPrompt")," "," ",o.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:d("footerTerms")})," ",d("and")," "," ",o.jsx("a",{href:"#",className:"text-[var(--color-primary-accent)] hover:underline font-medium",children:d("footerPrivacy")}),"."]})]})})};U.displayName="SignInPage";export{U as default};
