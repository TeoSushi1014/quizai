import{j as e}from"./ui-BGuvgkTr.js";import{r as n,f as V,u as X}from"./router-BxjC687J.js";import{c as M,l,C as f,L as T,B as d,W as A,u as W,X as Z,M as L,o as E,m as J,Y as K,w as O,q as ee,Z as F,_ as te,$ as re}from"./index-BRRMTy5t.js";import{q as ae}from"./quizResultsService-Ayh6hv2j.js";import"./vendor-DoC2WAmd.js";import"./utils-rUpm7H1u.js";import"./markdown-Bj7tmv2T.js";const se=({quizId:i,isOwner:r,currentUserId:u})=>{M();const[x,y]=n.useState([]),[N,g]=n.useState(!0),[s,v]=n.useState(null);n.useEffect(()=>{m()},[i,r,u]);const m=async()=>{try{g(!0),v(null);const a=await ae.getQuizHistory({quizId:i,userId:r?void 0:u,limit:20});y(a),g(!1),l.info("Quiz history loaded","QuizHistory",{quizId:i,resultCount:a.length,isOwner:r})}catch(a){l.error("Failed to load quiz history","QuizHistory",{},a),v("Failed to load history"),g(!1)}},t=a=>{if(!a)return"--:--";const h=Math.floor(a/60),j=a%60;return`${h}:${j.toString().padStart(2,"0")}`},b=a=>new Date(a).toLocaleDateString("vi-VN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return N?e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-center py-4",children:[e.jsx(T,{}),e.jsx("span",{className:"ml-2 text-sm text-[var(--color-text-secondary)]",children:"Loading history..."})]})}):s?e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-sm text-[var(--color-danger-accent)] mb-2",children:s}),e.jsx(d,{onClick:m,variant:"outline",size:"sm",children:"Retry"})]})}):x.length===0?e.jsx(f,{className:"p-4",children:e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-[var(--color-text-secondary)]",children:r?"No attempts yet":"You haven't taken this quiz yet"})})}):e.jsxs(f,{className:"p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:[r?"Recent Results":"Your Results"," (",x.length,")"]})}),e.jsx("div",{className:"space-y-2",children:x.map(a=>e.jsx("div",{className:"flex items-center justify-between p-3 bg-[var(--color-bg-surface-2)] rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[r&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(A,{className:"w-4 h-4 text-[var(--color-text-secondary)]"}),e.jsx("span",{className:"text-sm font-medium text-[var(--color-text-primary)]",children:a.user_name})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:`font-semibold ${a.score>=80?"text-[var(--color-success-accent)]":a.score>=60?"text-[var(--color-warning-accent)]":"text-[var(--color-danger-accent)]"}`,children:[a.score,"%"]}),e.jsxs("span",{className:"text-xs text-[var(--color-text-secondary)]",children:["(",Math.round(a.score/100*a.total_questions),"/",a.total_questions,")"]})]}),e.jsx("span",{className:"text-xs text-[var(--color-text-muted)]",children:t(a.time_taken)}),e.jsx("span",{className:"text-xs text-[var(--color-text-muted)]",children:b(a.created_at)})]})},a.id))}),x.length>=20&&e.jsx("div",{className:"mt-3 text-center",children:e.jsx(d,{variant:"ghost",size:"sm",onClick:m,children:"Load More"})})]})},ie=()=>{var q,k,C,P;const{quizId:i}=V(),{t:r}=M(),u=X(),{quizzes:x,addQuiz:y,setActiveQuiz:N,setQuizResult:g,currentUser:s,showSuccessNotification:v,showErrorNotification:m}=W(),[t,b]=n.useState(null),[a,h]=n.useState(!0),[j,p]=n.useState(null),[z,Q]=n.useState(!1),[w,I]=n.useState(!1);n.useEffect(()=>{(async()=>{if(h(!0),p(null),!i){l.warn("SharedQuizPage: No quizId in params.","SharedQuizPage"),p(r("sharedQuizNotFound")),h(!1);return}if(!F(i)&&i.length<30){l.warn("SharedQuizPage: Invalid quiz ID format and too short to be a corrupted ID.","SharedQuizPage",{quizId:i}),p(r("sharedQuizNotFound")),h(!1);return}F(i)||l.info("SharedQuizPage: Detected potentially corrupted quiz ID, proceeding to sharing service for recovery","SharedQuizPage",{quizId:i});try{if(s){const D=x.find(G=>G.id===i);if(D){l.info("SharedQuizPage: Displaying quiz owned by current user.","SharedQuizPage",{quizId:i}),b(D),h(!1);return}}const c=await te(i,s);c?(l.info("SharedQuizPage: Quiz data fetched successfully.","SharedQuizPage",{quizId:i}),b(c)):(l.warn("SharedQuizPage: Quiz not found via getSharedQuiz.","SharedQuizPage",{quizId:i}),p(r("sharedQuizNotFound")))}catch(c){l.error("Error loading shared quiz:","SharedQuizPage",{quizId:i},c),p(r("sharedQuizLoadError"))}finally{h(!1)}})()},[i,x,r,s]);const R=async()=>{const o=window.location.href;try{await navigator.clipboard.writeText(o),Q(!0),setTimeout(()=>Q(!1),2e3)}catch(c){l.error("Failed to copy share link from SharedQuizPage:","SharedQuizPage",void 0,c)}},$=()=>{t&&(N(t),g(null),u(`/quiz/${t.id}`))},S=()=>!t||!s?!1:x.some(o=>o.title===t.title&&o.questions.length===t.questions.length),_=async()=>{if(!t||!s){m("Please log in to save quizzes");return}if(S()){m("This quiz is already saved to your collection");return}I(!0);try{const o={...t,id:re(),userId:s.id,createdAt:new Date().toISOString(),lastModified:new Date().toISOString(),isShared:!1,sharedTimestamp:void 0};y(o),v("Quiz saved to your collection!"),l.info("Shared quiz saved to user collection","SharedQuizPage",{originalQuizId:t.id,newQuizId:o.id,userId:s.id})}catch(o){l.error("Failed to save shared quiz","SharedQuizPage",{quizId:t.id},o),m("Failed to save quiz. Please try again.")}finally{I(!1)}};if(a)return e.jsx("div",{className:"min-h-[calc(100vh-200px)] flex items-center justify-center",children:e.jsx(T,{text:r("loading")+"...",size:"xl"})});if(j||!t)return e.jsx("div",{className:"container mx-auto px-4 py-8 sm:py-12",children:e.jsxs(f,{className:"max-w-lg mx-auto mt-10 sm:mt-16 p-8 text-center animate-fadeInUp shadow-2xl",useGlassEffect:!0,children:[e.jsx(Z,{className:"w-16 h-16 text-[var(--color-danger-accent)] mx-auto mb-6"}),e.jsx("h2",{className:"text-2xl font-semibold text-[var(--color-text-primary)] mb-3",children:r("sharedQuizError")}),e.jsx("p",{className:"text-[var(--color-text-secondary)] mb-4",children:j||r("sharedQuizNotFound")}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[e.jsx(d,{variant:"primary",onClick:()=>u("/"),size:"lg",className:"py-3 px-8 rounded-xl",children:r("home")}),e.jsx(d,{variant:"outline",onClick:()=>u("/create"),size:"lg",className:"py-3 px-8 rounded-xl",children:r("createQuiz")})]})]})});const H=(q=t.config)!=null&&q.difficulty&&t.config.difficulty!=="AI-Determined"?r(`step2Difficulty${t.config.difficulty}`):((k=t.config)==null?void 0:k.difficulty)==="AI-Determined"?r("dashboardQuizCardDifficulty"):r("notSpecified"),U=(C=t.config)!=null&&C.language?t.config.language.toLowerCase()==="english"?r("step2LanguageEnglish"):r("step2LanguageVietnamese"):r("notSpecified"),Y=t.createdAt?new Date(t.createdAt).toLocaleDateString():r("notSpecified"),B=t.lastModified?new Date(t.lastModified).toLocaleDateString():r("notSpecified");return e.jsxs("div",{className:"container mx-auto px-4 py-8 sm:py-12",children:[e.jsxs(f,{className:"max-w-3xl mx-auto shadow-2xl !rounded-2xl animate-fadeInUp",useGlassEffect:!0,children:[e.jsxs("div",{className:"border-b border-[var(--color-border-default)] pb-6 mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] leading-tight tracking-tight line-clamp-3",title:t.title,children:e.jsx(L,{text:t.title,markdownFormatting:!0})}),e.jsx(d,{variant:"outline",size:"sm",onClick:R,leftIcon:z?e.jsx(E,{className:"w-4 h-4 text-[var(--color-success-accent)]"}):e.jsx(J,{className:"w-4 h-4"}),className:`!py-2 px-4 rounded-lg shadow-sm flex-shrink-0 ${z?"!border-[var(--color-success-accent)] !text-[var(--color-success-accent)]":"!border-[var(--color-border-interactive)] hover:!border-[var(--color-primary-accent)]"}`,children:r(z?"copied":"copyShareLink")})]}),((P=t.creator)==null?void 0:P.name)&&e.jsxs("div",{className:"flex items-center text-sm text-[var(--color-text-secondary)] mt-3",children:[e.jsx(A,{className:"w-4 h-4 mr-2 text-[var(--color-text-muted)]"}),e.jsxs("span",{children:[r("dashboardQuizCardCreated",{date:""})," ",t.creator.name]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex justify-between items-center mb-5",children:e.jsx("h2",{className:"text-xl font-semibold text-[var(--color-text-primary)]",children:r("quizDetails")})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 text-center sm:text-left mb-4",children:[e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsx("p",{className:"text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1",children:r("numberOfQuestions")}),e.jsx("p",{className:"text-2xl font-bold text-[var(--color-text-primary)]",children:t.questions.length})]}),e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsx("p",{className:"text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1",children:r("difficulty")}),e.jsx("p",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:H})]}),e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsx("p",{className:"text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1",children:r("step2LanguageLabel")}),e.jsx("p",{className:"text-lg font-semibold text-[var(--color-text-primary)]",children:U})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-center sm:text-left",children:[e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/30 p-3 rounded-lg border border-[var(--color-border-default)]/50",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--color-text-muted)] mb-1",children:"Created"}),e.jsx("p",{className:"text-sm text-[var(--color-text-primary)]",children:Y})]}),e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/30 p-3 rounded-lg border border-[var(--color-border-default)]/50",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--color-text-muted)] mb-1",children:"Last Modified"}),e.jsx("p",{className:"text-sm text-[var(--color-text-primary)]",children:B})]})]}),t.sourceContentSnippet&&e.jsxs("div",{className:"mt-4 bg-[var(--color-bg-surface-2)]/30 p-4 rounded-lg border border-[var(--color-border-default)]/50",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--color-text-muted)] mb-2",children:"Source Content"}),e.jsx("p",{className:"text-sm text-[var(--color-text-secondary)] line-clamp-3",children:t.sourceContentSnippet})]})]}),t.questions&&t.questions.length>0&&e.jsxs("div",{className:"mb-10",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--color-text-primary)] mb-5",children:r("previewQuestions")}),e.jsx("div",{className:"space-y-4",children:t.questions.slice(0,3).map((o,c)=>e.jsxs("div",{className:"bg-[var(--color-bg-surface-2)]/60 p-4 sm:p-5 rounded-xl border border-[var(--color-border-default)] shadow-md",children:[e.jsxs("div",{className:"font-medium text-[var(--color-text-primary)] mb-2 text-sm sm:text-base",children:[e.jsxs("span",{className:"text-[var(--color-primary-accent)] mr-2 font-semibold",children:[c+1,"."]}),e.jsx(L,{text:o.questionText,markdownFormatting:!0})]}),c===2&&t.questions.length>3&&e.jsx("p",{className:"text-xs text-[var(--color-text-muted)] italic text-center mt-3",children:r("andMoreQuestions",{count:t.questions.length-3})}),c<2&&t.questions.length>1&&e.jsx("p",{className:"text-xs text-[var(--color-text-muted)] italic mt-2",children:r("moreQuestionsInQuiz")})]},o.id))})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center items-center gap-4 pt-6 border-t border-[var(--color-border-default)]",children:[e.jsx(d,{variant:"primary",size:"lg",onClick:$,leftIcon:e.jsx(K,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-10 rounded-xl bg-gradient-to-r from-[var(--color-primary-accent)] to-indigo-500 hover:from-[var(--color-primary-accent-hover)] hover:to-indigo-600 shadow-xl",children:r("takeQuizNow")}),s&&!S()&&e.jsx(d,{variant:"outline",size:"lg",onClick:_,disabled:w,leftIcon:e.jsx(O,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-8 rounded-xl border-green-500/50 text-green-600 hover:bg-green-50 hover:border-green-500 dark:border-green-400/50 dark:text-green-400 dark:hover:bg-green-900/20",children:w?"Saving...":"Save Quiz"}),s&&S()&&e.jsx(d,{variant:"outline",size:"lg",disabled:!0,leftIcon:e.jsx(E,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-8 rounded-xl border-green-500/50 text-green-600 bg-green-50 dark:border-green-400/50 dark:text-green-400 dark:bg-green-900/20",children:"Already Saved"}),e.jsx(d,{variant:"outline",size:"lg",onClick:()=>u("/create"),leftIcon:e.jsx(ee,{className:"w-5 h-5"}),className:"w-full sm:w-auto py-3.5 px-8 rounded-xl",children:r("createQuiz")})]})]}),t&&e.jsx("div",{className:"mt-6",children:e.jsx(se,{quizId:t.id,isOwner:(s==null?void 0:s.id)===t.userId,currentUserId:s==null?void 0:s.id})})]})};ie.displayName="SharedQuizPage";export{ie as default};
